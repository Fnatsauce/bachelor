<!DOCTYPE html>
<meta charset="UTF-8">
<html>
    <head>
        <title>game</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css"></link>
    </head>
    <body onload="startTutorial()">
        <div style="display:none;">
            <!-- Player animations -->
            <img id="playerIdleImage"
                src="PlayerCharacter/Idle.png">
            <img id="playerAttackFireImage"
                src="PlayerCharacter/Attack2-fire.png">
            <img id="playerAttackIceImage"
                src="PlayerCharacter/Attack2-ice.png">
            <img id="playerAttackAirImage"
                src="PlayerCharacter/Attack1-air.png">
            <img id="playerDeathImage"
                src="PlayerCharacter/Death.png">

            <!-- Player spell-attack animations -->
            <img id="fireball"
                src="GameFXexport/SPRITESHEET_Files/FireBall_64x64.png">
            <img id="icepick"
                src="GameFXexport/SPRITESHEET_Files/IcePick_64x64.png">
            <img id="tornadoStatic"
                src="GameFXexport/SPRITESHEET_Files/TornadoStatic_96x96.png">
            <img id="tornadoLoop"
                src="GameFXexport/SPRITESHEET_Files/TornadoLoop_96x96.png">

            <!-- Attack-hit-effect animations -->
            <img id="Fire-hit"
                src="GameFXexport/SPRITESHEET_Files/Explosion_96x96.png">
            <img id="Ice-hit"
                src="GameFXexport/SPRITESHEET_Files/IceShatter_96x96.png">
            
            <img id="Air-hit"
                src="GameFXexport/SPRITESHEET_Files/PoisonCast_96x96.png">
            <img id="TornadoLoop"
                src="GameFXexport/SPRITESHEET_Files/TornadoLoop_96x96.png">

            <!-- Enemy animations -->
            <img id="wizardIdleImage"
                src="enemyWizard/Idle.png">
            <img id="wizardResistImage"
                src="enemyWizard/Hit.png">
            <img id="wizardDeathImage"
                src="enemyWizard/Death.png">
          
            <img id="flyingEyeIdleImage"
                src="flyingEye/Idle.png">
            <img id="flyingEyeResistImage"
                src="flyingEye/Hit.png">
            <img id="flyingEyeDeathImage"
                src="flyingEye/Death.png">

            <img id="mushroomIdleImage"
                src="mushroom/Idle.png">
            <img id="mushroomResistImage"
                src="mushroom/Hit.png">
            <img id="mushroomDeathImage"
                src="mushroom/Death.png">

            <img id="goblinIdleImage"
                src="goblin/Idle.png">
            <img id="goblinResistImage"
                src="goblin/Hit.png">
            <img id="goblinDeathImage"
                src="goblin/Death.png">

            <img id="skeletonIdleImage"
                src="skeleton/Idle.png">
            <img id="skeletonResistImage"
                src="skeleton/Hit.png">
            <img id="skeletonDeathImage"
                src="skeleton/Death.png">
            <img id="skeletonAttackImage"
                src="skeleton/Attack.png">

            <img id="slimeIdleImage"
                src="slime/Idle.png">
            <img id="slimeResistImage"
                src="slime/Hit.png">
            <img id="slimeAttackImage"
                src="slime/Attack.png">


            <!-- Overview map -->
            <img id="tutorialMap"
                src="tutorialMap.png">
            <img id="familiarityMap"
                src="highFamMap.png">
            <img id="resistBar"
                src="resistBar.png">
            <img id="fade"
                src="fade.png">

            <!-- Text background -->
            <img id="textBackground"
                src="textBackground.png">
        
            <!-- Cross animation -->
            <img id="cross"
                src="cross.png">
        </div>
        
        <!-- Background image -->
        <img id="backgroundImage" class="background"
            src="templeBackground.png"
            ondragstart="return false;">>


        <div class="page" oncontextmenu="return false">
            <canvas id="canvas2" width="1200" height="600"></canvas>
            
            <canvas id="canvas1" width="1200" height="600"></canvas>
            <canvas id="canvas3" width="1200" height="600"></canvas>
            <div class="overlay">
                <img id="fireIcon" class="spell"
                    src="spellIcons/fire.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Fire')"
                    ondragstart="return false;">
                <img id="iceIcon" class="spell"
                    src="spellIcons/ice.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Ice')"
                    ondragstart="return false;">
                <img id="airIcon" class="spell"
                    src="spellIcons/air.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Air')"
                    ondragstart="return false;">
                <img id="fadedSpells1" src="fadedSpells1.png">
                <img id="fadedSpells2" src="fadedSpells2.png">
                <input id="nextButton" type="image" src="nextButtonUnpressed.png" name="nextButton" ondragstart="return false;" onmousedown="document.getElementById('nextButton').src = 'nextButtonPressed.png'" onmouseup="document.getElementById('nextButton').src = 'nextButtonUnpressed.png'"/>
            </div>

            <!--
            <div id="svgholder">
                <svg id="svg" width="1200" height="600" disabled>
                    <polygon id="fire" class="poly" points="190, 155, 190 251, 286 251, 286 155"
                    onclick="lineSegments[0].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="ice" class="poly" points="240 255, 240 351, 336 351, 336 255" 
                    onclick="lineSegments[1].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="air" class="poly" points="190 355, 190 451, 286 451, 286 355"
                    onclick="lineSegments[2].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>
                </svg>
            </div>
            -->

            <button onclick="gameWindow.pause();">Pause</button>
            <button onclick="gameWindow.resume();">Resume</button>
            <button onclick="Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.display = 'block';});">Enable attacks</button>
        </div>

        <div id="explanation" class="modal">
            <!-- Modal content -->
            <div class="modal-content explanation">
                <div class="hidden readable-tutorial" id="projectExplanation">
                    <p>Thank you for wanting to help out in our project. Please select a language</p>
                    <button onclick="setLanguage('dk')">Dansk</button>
                    <button onclick="setLanguage('en')">English</button>
                </div>
                <p class="hidden readable-tutorial" id="practiceExplanation">Before the game begins you will be fighting 7 wizards to get a feel for the game. The wizards are as you learned in the tutorial weak to all attacks, so don't worry about what spell is the right one, they all are.</p>
                <div class="hidden readable-tutorial" id="gameExplanation">
                    <img id="noIndicationMap"
                        src="noIndicationMap.png">
                    <img id="indicationMap"
                        src="gameMap.png">
                    <p>Here is a map of the enemies you will be fighting in the game as well as the abilities you will have available. Please rate on a scale from 1 (very unsure) to 10 (pretty certain) how certain you are that you will be able to defeat all the enemies</p>
                </div>
                <p class="hidden readable-tutorial" id="endOfGame">Thanks for playing! Please take a minute to answer our survey about your experience found <a id="surveyLink" href="">here</a></p>

                <div class="hidden" id="confidence" onclick="setConfidence()">
                    <p>not confident</p>
                    <label class="radio_button first" for="confidence1">
                        <span class="confidence_number">1</span>
                        <input type="radio" id="confidence1" name="confidence" value="1">
                    </label>
                    <label class="radio_button" for="confidence2">
                        <span class="confidence_number">2</span>
                        <input type="radio" id="confidence2" name="confidence" value="2">
                    </label>
                    <label class="radio_button" for="confidence3">
                        <span class="confidence_number">3</span>
                        <input type="radio" id="confidence3" name="confidence" value="3">
                    </label>
                    <label class="radio_button" for="confidence4">
                        <span class="confidence_number">4</span>
                        <input type="radio" id="confidence4" name="confidence" value="4">
                    </label>
                    <label class="radio_button" for="confidence5">
                        <span class="confidence_number">5</span>
                        <input type="radio" id="confidence5" name="confidence" value="5">
                    </label>
                    <label class="radio_button" for="confidence6">
                        <span class="confidence_number">6</span>
                        <input type="radio" id="confidence6" name="confidence" value="6">
                    </label>
                    <label class="radio_button" for="confidence7">
                        <span class="confidence_number">7</span>
                        <input type="radio" id="confidence7" name="confidence" value="7">
                    </label>
                    <label class="radio_button" for="confidence8">
                        <span class="confidence_number">8</span>
                        <input type="radio" id="confidence8" name="confidence" value="8">
                    </label>
                    <label class="radio_button" for="confidence9">
                        <span class="confidence_number">9</span>
                        <input type="radio" id="confidence9" name="confidence" value="9">
                    </label>
                    <label class="radio_button" for="confidence10">
                        <span class="confidence_number">10</span>
                        <input type="radio" id="confidence10" name="confidence" value="10">
                    </label>
                    <p>very confident</p>
                </div>
                <button onclick="closeExplanation()">Click here when you're done</button>
            </div>
        </div>
    </body>

    <script>
        var participantGroup = Math.floor(Math.random() * 2) + 1;

        var participantGroup = 2;

        function setLanguage(language) {
            //document.getElementById("practiceExplanation").innerHTML = 
        }

        function startTutorial() {
            document.getElementById("projectExplanation").style.display = "block";
            document.getElementById("explanation").style.display = "block";
            gameWindow.start();
            gameWindow.tutorial = true;
            entities.campaign = campaigns[0];
            entities.campaign.start();
            Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "none";});
            gameWindow.context2.drawImage(document.getElementById("tutorialMap"), 0, 0);
            tutorialSteps[0].draw();       
        }

        function startPractice() {
            document.getElementById("projectExplanation").style.display = "none";
            document.getElementById("practiceExplanation").style.display = "block";
            document.getElementById("explanation").style.display = "block";
            entities.campaign = campaigns[1];
            entities.campaign.start();
            gameWindow.context2.drawImage(document.getElementById("familiarityMap"), 0, 0);
        }

        function startGame() {
            document.getElementById("practiceExplanation").style.display = "none";
            document.getElementById("gameExplanation").style.display = "block";
            
            document.getElementById("confidence").style.display = "flex";
            document.getElementById("explanation").style.display = "block";
            
            if(participantGroup < 3) {
                entities.campaign = campaigns[2];
                gameWindow.context2.drawImage(document.getElementById("noIndicationMap"), 0, 0);
                document.getElementById("indicationMap").style.display = "none";
            } else {
                entities.campaign = campaigns[3];
                gameWindow.context2.drawImage(document.getElementById("indicationMap"), 0, 0);
                document.getElementById("noIndicationMap").style.display = "none";
            }
            entities.campaign.start();
        }

        function endGame() {
            console.log("end");
            document.getElementById("explanation").style.display = "none";
            document.getElementById("confidence").style.display = "none";
            document.getElementById("gameExplanation").style.display = "block";
            document.getElementById("endOfGame").style.display = "block";
        }

        function closeExplanation() {
            document.getElementById("explanation").style.display = "none";
        }

        function setConfidence() {
            var rates = document.getElementsByName("confidence");
            var confidenceValue;
            for(var i = 0; i < rates.length; i++) {
                if(rates[i].checked) {
                    confidenceValue = rates[i].value;
                }
            }
            document.getElementById("surveyLink").href = "https://docs.google.com/forms/d/e/1FAIpQLSfa0Nt08lBclw7pM523cVVIdbdM2qIqvwJjWpevGgleaQ_FtQ/viewform?usp=pp_url&entry.755563979=" + participantGroup + "&entry.146232743=" + confidenceValue;
        }

        function campaignFinished(campaign) {
            gameWindow.restart();
            if(campaign == 2) {
                if(participantGroup % 2 == 0) {
                    startPractice()
                } else {
                    startGame();
                }
            } else if(campaign == 7) {
                startGame();
            } else {
                endGame();
            }
        }

        var spellsUsed = "";
        var drawables = {};
        var tutorialSteps = [];
        var entities = {};
        var gameWindow = {
            tutorial : false,
            stopGame : false,
            gameRunning : true,
            canvas1 : document.getElementById("canvas1"),
            context1 : this.canvas1.getContext("2d"),
            canvas2 : document.getElementById("canvas2"),
            context2 : this.canvas2.getContext("2d"),
            canvas3 : document.getElementById("canvas3"),
            context3 : this.canvas3.getContext("2d"),

            start : function() {
                entities.player = new PlayerCharacter();
                this.context1.webkitImageSmoothingEnabled = false;
                this.context1.imageSmoothingEnabled = false;
                this.context1.msImageSmoothingEnabled = false;
                window.requestAnimationFrame(this.draw);
            },

            restart : function() {
                drawables = {};
                entities = {};
                entities.player = new PlayerCharacter();
                this.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.context2.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.context3.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.tutorial = false;
            },

            pause : function() {
                this.stopGame = true;
                this.gameRunning = false;
            },

            resume : function() {
                if(!this.gameRunning) {
                    this.gameRunning = true;
                    window.requestAnimationFrame(this.draw);
                }
            },

            draw : function() {
                if (gameWindow.stopGame) {
                    gameWindow.stopGame = false;
                    return;
                }
                gameWindow.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                for (var key of Object.keys(drawables)) {
                    drawables[key].draw(gameWindow.context1);
                }
                window.requestAnimationFrame(gameWindow.draw);
            },

            clearText : function() {
                this.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);
                drawTextBox("");
            }
        }

        class PlayerCharacter {
            constructor() {
                this.animationFrame = 0;
                this.frameSize = {x:231, y:190};
                this.size = {x:400, y:400};
                this.x = 100 - this.size.x / 2;
                this.y = 340 - this.size.y / 2;
                this.fps = 10;
                this.playerImage = document.getElementById("playerIdleImage");
                this.fireball = document.getElementById("fireball");
                this.icepick = document.getElementById("icepick");
                this.tornadoStatic = document.getElementById("tornadoStatic");
                this.tornadoLoop = document.getElementById("tornadoLoop");
                drawables["3-player"] = new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps);
            }

            attack(attackType) {
                var idle = getAnimation(new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps));

                Array.prototype.forEach.call(document.getElementsByClassName("spell"), function(icon) {icon.style.display = "none";});

                var attackHit = function() {
                    if (this.x > this.targetX) {
                        entities.enemy.hit(attackType);
                    }
                }
                switch (attackType) {
                    case "Fire":
                        spellsUsed += "1";
                        var projectileAnimation = getAnimation(new MovingAnimation(this.fireball, 140, 205, 970, 225, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        break;
                    case "Ice":
                        spellsUsed += "2";
                        var projectileAnimation = getAnimation(new MovingAnimation(this.icepick, 150, 205, 960, 225, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        break;
                    case "Air":
                        spellsUsed += "3";
                        var tornadoLoopAnimation = getAnimation(new MovingAnimation(this.tornadoLoop, 560, 270, 1000, 270, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        var tornadoCallback = function() {
                            if (this.x > this.targetX) {
                                tornadoLoopAnimation();
                            }
                        } 
                        var projectileAnimation = getAnimation(new MovingAnimation(this.tornadoStatic, 100, 270, 550, 270, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, tornadoCallback));
                        break;
                }
                var animation = function() {
                    if(this.currentCycle == this.cycles) {
                        idle();
                    }
                    if(this.animationFrame == 36) {
                        projectileAnimation();
                        sortDrawables();
                    }
                }
                drawables["3-player"] = new Animation(document.getElementById("playerAttack" + attackType + "Image") , this.x, this.y, this.frameSize, this.size, 1, "3-player", this.fps, animation);
            }

            getDeathAnimation(callBack) {
                var deathAnimation = getAnimation(new Animation(document.getElementById("playerDeathImage"), this.x, this.y, this.frameSize, this.size, 1, "3-player", this.fps, callBack));
                return deathAnimation;
            }
        }

        class Enemy {
            constructor(x, y, name, frameSize, size) {
                this.name = name;
                this.animationFrame = 0;
                this.frameSize = frameSize
                this.size = size;
                this.x = x;
                this.y = y;
                this.fps = 10;
                this.idleImage = document.getElementById(name + "IdleImage");
                this.attackImage = document.getElementById(name + "AttackImage");
                this.resistImage = document.getElementById(name + "ResistImage");
                this.deathImage = document.getElementById(name + "DeathImage");
                this.resistBarImage = document.getElementById("resistBar");
            }

            initialize() {
                drawables["1-enemy"] = new Animation(this.idleImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
                sortDrawables();
            }

            hit(attackType) {
                this.playHitEffectAnimation(attackType);
                drawables["1-enemy"] = new Animation(this.resistImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
                var deathDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        this.freezeAnimation();
                        if (gameWindow.tutorial) {
                            document.getElementById("nextButton").style.display = "block";
                            gameWindow.pause();
                            document.getElementById("nextButton").disabled = false;
                        }
                        entities.campaign.nextRoom();
                    }
                }
                var deathAnimation = getAnimation(new Animation(this.deathImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps, deathDone));

                var playerDeathDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        this.freezeAnimation();
                        entities.campaign.nextRoom();
                    }
                }
                var playerDeathAnimation = entities.player.getDeathAnimation(playerDeathDone);
                var attackDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        playerDeathAnimation();
                        entities.enemy.initialize();
                    }
                }
                var attackAnimation = getAnimation(new Animation(this.attackImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps, attackDone));
                var resist = function() {
                    if (this.animationFrame == 30 && gameWindow.tutorial && entities.enemy.name != "slime") {
                        gameWindow.pause();
                        document.getElementById("nextButton").style.display = "block";
                        tutorialSteps[6].draw();
                    }
                    if(this.currentCycle >= this.cycles) {
                        delete drawables["2-TornadoLoop"];
                        attackAnimation();
                        var ctx = gameWindow.context3;
                        ctx.font = "50px Arial";
                        ctx.fillStyle = "orange";
                        ctx.fillText("RESISTED", 920, 275);
                    }
                    if(this.animationFrame == 60) {
                        var attackingEnemies = ["slime", "skeleton"];
                        if(!attackingEnemies.includes(entities.enemy.name) && !entities.campaign.currentRoom == entities.campaign.rooms.length - 1) {
                            this.delete();
                            delete drawables["2-TornadoLoop"];
                            deathAnimation();
                        }
                    }
                }
                drawables.resistBar = new Animation(this.resistBarImage, 1170, 310, {x:15, y:85}, {x:15, y:85}, 1, "resistBar", 5, resist);
            }

            playHitEffectAnimation(attackType) {
                switch (attackType) {
                    case "Fire":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 155, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 40);
                        break;
                    case "Ice":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 195, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 40);
                        break;
                    case "Air":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 185, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 70);
                        drawables["2-TornadoLoop"] = new Animation(document.getElementById("TornadoLoop"), 990, 235, {x:96, y:96}, {x:250, y:250}, Infinity, "2-TornadoLoop", 50);
                        break;
                }
            }
        }

        

        function getAnimation(animation) {
            return function() {
                drawables[animation.key] = animation;
            };
        }

        function sortDrawables() {
            drawables = Object.keys(drawables).sort().reduce(
                (obj, key) => { 
                    obj[key] = drawables[key]; 
                    return obj;
                }, {}
            );
        }

        class Animation {
            constructor(image, x, y, frameSize, size, cycles, key, fps, callBack) {
                this.image = image;
                this.x = x;
                this.y = y;
                this.frameSize = frameSize;
                this.size = size;
                this.animationFrame = 0;
                this.cycles = cycles;
                this.currentCycle = 0;
                this.key = key;
                this.callBack = callBack;
                this.wait = 60/fps;
                this.freeze = false;
            }
        
            draw(context) {
                //drawImage(image, dx, dy, dxWidth, dyHeight, x, y, xWidth, yHeight)
                context.drawImage(this.image, this.frameSize.x * Math.floor(this.animationFrame / this.wait), 0, this.frameSize.x, this.frameSize.y, this.x, this.y, this.size.x, this.size.y);
                if(!this.freeze) {
                    this.animationFrame++;
                    if (this.animationFrame > this.image.width / this.frameSize.x * this.wait - 1) {
                        this.animationFrame = 0;
                        this.currentCycle++;
                    }
                    if (this.currentCycle >= this.cycles) {
                        this.delete();
                    }
                    if (this.callBack != undefined) {
                        this.callBack();
                    }
                }
            }

            delete() {
                delete drawables[this.key];
            }

            freezeAnimation() {
                this.freeze = true;
            }

            unfreezeAnimation() {
                this.freeze = false;
            }
        }

        class MovingAnimation extends Animation{
            constructor(image, x, y, targetX, targetY, frameSize, size, key, fps, lifetime, callBack) {
                super(image, x, y, frameSize, size, Infinity, key, fps, callBack);
                this.targetX = targetX;
                this.targetY = targetY;
                this.ratioX = (targetX - x) / lifetime;
                this.ratioY = (targetY - y) / lifetime;
            }

            draw(context) {
                if (this.x > this.targetX) {
                    this.delete();
                }
                super.draw(context);
                this.x += this.ratioX;
                this.y += this.ratioY;
            }
        }

        function highlightArea(area) {
            var ctx = gameWindow.context3;
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.beginPath();
            area();
            ctx.rect(1200, 0, -1200, 450);
            ctx.fill();
        }

        function drawTextBox(text) {
            var ctx = gameWindow.context3;
            ctx.drawImage(document.getElementById("textBackground"), 0, 450);
            ctx.font = "15px Arial";
            var lines = wrapText(ctx, text, 1100)
            ctx.beginPath();
            ctx.fillStyle = "white";
            var textY = 490;
            lines.forEach(line => {
                ctx.fillText(line, 60, textY);
                textY += 20;
            });
        }

        function wrapText(ctx, text, maxWidth) {
            var words = text.split(" ");
            var lines = [];
            var currentLine = words[0];

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                if (word == "\n") {
                    lines.push(currentLine);
                    i++;
                    while (words[i] == "\n") {
                        lines.push("");
                        i++;
                    }
                    currentLine = words[i];
                    continue;
                }
                var width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        class Campaign {
            constructor(rooms, mapPortraitPosition) {
                this.rooms = rooms;
                this.currentRoom = 0;
                this.mapPortraitPosition = mapPortraitPosition
            }

            nextRoom() {
                this.currentRoom++;
                var fadeCallback;
                if(this.rooms.length > this.currentRoom) {
                    var crossCallback = function() {
                        if (this.currentCycle >= this.cycles) {
                            gameWindow.context2.drawImage(document.getElementById("cross"), 825, 0, 75, 75, entities.campaign.mapPortraitPosition + 140 * (entities.campaign.currentRoom - 1), 30, 75, 75);
                            drawables["8-fade"].unfreezeAnimation();
                        }
                    }
                    var cross = getAnimation(new Animation(document.getElementById("cross"), this.mapPortraitPosition + 140 * (this.currentRoom - 1), 30, {x:75, y:75}, {x:75, y:75}, 1, "9-cross", 15, crossCallback));
                    fadeCallback = function() {
                        if (this.animationFrame == 60) {
                            cross();
                            drawables["8-fade"].freeze = true;
                            entities.campaign.rooms[entities.campaign.currentRoom].prepareEnemy();
                        }
                        if (this.currentCycle >= this.cycles) {
                            gameWindow.clearText();
                            if (gameWindow.tutorial) {
                                tutorialSteps[9].draw();
                                document.getElementById("nextButton").style.display = "block";
                            } else {
                                drawTextBox("the next room is now");
                            }
                            entities.campaign.rooms[entities.campaign.currentRoom].prepareSpells();
                        }
                    }
                } else {
                    fadeCallback = function() {
                        if (this.animationFrame == 60) {
                            drawables["8-fade"].freeze = true;
                            campaignFinished(entities.campaign.currentRoom);
                        }
                    }
                }
                if (!gameWindow.tutorial) {
                    gameWindow.clearText();
                }
                drawables["8-fade"] = new Animation(document.getElementById("fade"), 0, 150, {x:1, y:1}, {x:1200, y:450}, 1, "8-fade", 10, fadeCallback);
            }

            start() {
                this.rooms[this.currentRoom].prepareEnemy();
                this.rooms[this.currentRoom].prepareSpells();
                drawTextBox("ze first room is now");
            }
        }

        class Room {
            constructor(enemy, unavailableSpell) {
                this.enemy = enemy;
                this.unavailableSpell = unavailableSpell;
            }

            prepareEnemy() {
                entities.enemy = this.enemy;
                this.enemy.initialize();
            }

            prepareSpells() {
                Array.prototype.forEach.call(document.getElementsByClassName("spell"), function(icon) {icon.style.display = "block";});
                if(this.unavailableSpell != undefined) {
                    document.getElementById(this.unavailableSpell + "Icon").style.display = "none";
                }
            }
        }

        class TutorialStep {
            constructor(area, text, nextFunction, pause) {
                this.area = area;
                this.text = text;
                this.pause = pause;
                this.nextFunction = nextFunction;
            }
            
            draw() {
                if (this.pause) {
                    gameWindow.pause();
                }
                gameWindow.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);
                if (this.area != undefined) {
                    highlightArea(this.area);
                }
                drawTextBox(this.text);
                document.getElementById("nextButton").onclick = this.nextFunction
            }
        }


        var campaigns = [
            new Campaign([
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(980, 240, "slime", {x:32, y:25}, {x:200, y:200}), "ice")
            ], 493),
            new Campaign([
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "fire"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "ice"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
            ], 144),
            new Campaign([
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "ice"),
            ], 144),
            new Campaign([
                new Room(new Enemy(870, 100, "mushroom", {x:150, y:150}, {x:500, y:500}), undefined),
                new Room(new Enemy(910, 160, "flyingEye", {x:150, y:150}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 160, "goblin", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "ice")
            ], 144)
        ];

        tutorialSteps.push( new TutorialStep(
            undefined, 
            'Welcome to One-Shot Wizard! \n My name is: The-Handy-Dandy-Tutorial-Text and I will now guide you through how to play the game - please click "next" to continue.', 
            function() {document.getElementById("fadedSpells1").style.display = "block"; tutorialSteps[1].draw();}, false)
        );
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.arc(85, 345, 100, 0, 2 * Math.PI)}, 
            'This is you.', 
            function() {tutorialSteps[2].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.arc(1115, 345, 100, 0, 2 * Math.PI)}, 
            'This is your enemy. Each room in the game has one.', 
            function() {document.getElementById("fadedSpells1").style.display = "none"; tutorialSteps[3].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.ellipse(240, 300, 120, 170, 0, 0, 2 * Math.PI)}, 
            'To defeat an enemy you must choose an attack from the ones available. \n Certain enemies are weak to certain attacks and it is up to you to figure out what attack will be effective against the enemy you are currently facing. \n \n But choose wisely! Because you only get ONE SHOT! ;3', 
            function() {document.getElementById("fadedSpells1").style.display = "block"; tutorialSteps[4].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.arc(1115, 345, 100, 0, 2 * Math.PI)}, 
            'You are currently fighting this other wizard. \n Wizards are, as we all know, very weak and frail, so don\'t worry about figuring out what spell is best - Anything would do the trick!', 
            function() {
                document.getElementById("fadedSpells1").style.display = "none"; 
                Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "auto"; document.getElementById("nextButton").style.display = "none";}); 
                tutorialSteps[5].draw();
            }, false
        ));
        tutorialSteps.push(new TutorialStep(undefined, "Now choose a spell", function() {return}, false));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.ellipse(1178, 350, 20, 60, 0, 0, 2 * Math.PI)}, 
            'When hit, enemies will try to resist the attack. If the resistance bar reaches the top, the monster will recover from the spell and attack you back! \n Let\'s see how well the frail wizard can resist your attack...', 
            function() {gameWindow.resume(); tutorialSteps[7].draw(); document.getElementById("nextButton").style.display = "none";}, false
        ));
        tutorialSteps.push(new TutorialStep(undefined, "...", function() {tutorialSteps[8].draw();}, false));
        tutorialSteps.push(new TutorialStep(
            undefined, 
            'Great job! You defeated the frail wizard! \n \n Very impressive... \n \n When an enemy is defeated you will automatically move to the next room - so let\'s go there now!', 
            function() {Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "none";}); gameWindow.clearText(); gameWindow.resume(); document.getElementById("nextButton").style.display = "none";}, false
        ));
        // Transition to the next room!
        tutorialSteps.push(new TutorialStep(
            undefined, 
            'Welcome to room 2!', 
            function() {document.getElementById("fadedSpells2").style.display = "block"; tutorialSteps[10].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.arc(1100, 385, 100, 0, 2 * Math.PI)}, 
            'BE CAREFUL!!! \n A NEW ENEMY APPROACHES! \n \n What a terrifying creature indeed... It must be slain!', 
            function() {document.getElementById("fadedSpells2").style.display = "none"; tutorialSteps[11].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            undefined, 
            'But before you decide on what to attack with, take a look at your spells.', 
            function() {tutorialSteps[12].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.ellipse(240, 300, 120, 170, 0, 0, 2 * Math.PI)}, 
            'Notice Ice Spear is missing. \n You don\'t always have the same attacks available.', 
            function() {document.getElementById("fadedSpells2").style.display = "block"; tutorialSteps[13].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            function() {gameWindow.context3.ellipse(600, 75, 200, 75, 0, 0, 2 * Math.PI)}, 
            'To see what spells you will have available for each enemy, look at the top of the screen.\n The portraits portray the enemies you will face and the icons below it indicate what spells you will have available then. \n This allows you to think ahead and plan the attack you wish to use agains\'t a given enemy. \n \n Or don\'t think ahead - I don\'t care.', 
            function() {Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "auto";}); document.getElementById("fadedSpells2").style.display = "none"; document.getElementById("nextButton").style.display = "none"; tutorialSteps[14].draw();}, false
        ));
        tutorialSteps.push(new TutorialStep(
            undefined, 
            'And that is all I can teach you young Padawan. \n \n Now I wish you good luck against the Slime! Whether you win or lose, the actual game will start after this Slime-battle. \n \n Have fun!', 
            function() {}, false
        ));
    </script>
</html>
