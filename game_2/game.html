<!DOCTYPE html>
<html>
    <head>
        <title>game</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css"></link>
    </head>
    <body onload="startTutorial()">
        <div style="display:none;">
            
            <!-- Player animations -->
            <img id="playerIdleImage"
                src="PlayerCharacter/Idle.png">
            <img id="playerAttackFireImage"
                src="PlayerCharacter/Attack2-fire.png">
            <img id="playerAttackIceImage"
                src="PlayerCharacter/Attack2-ice.png">
            <img id="playerAttackAirImage"
                src="PlayerCharacter/Attack1-air.png">

            <!-- Player spell-attack animations -->
            <img id="fireball"
                src="GameFXexport/SPRITESHEET_Files/FireBall_64x64.png">
            <img id="icepick"
                src="GameFXexport/SPRITESHEET_Files/IcePick_64x64.png">
            <img id="tornadoStatic"
                src="GameFXexport/SPRITESHEET_Files/TornadoStatic_96x96.png">
            <img id="tornadoLoop"
                src="GameFXexport/SPRITESHEET_Files/TornadoLoop_96x96.png">

            <!-- Enemy animations -->
            <img id="wizardIdleImage"
                src="enemyWizard/Idle.png">
            <img id="wizardResistImage"
                src="enemyWizard/Hit.png">
            <img id="wizardDeathImage"
                src="enemyWizard/Death.png">
          
            <img id="flyingEyeIdleImage"
                src="flyingEye/Idle.png">
            <img id="goblinIdleImage"
                src="goblin/Idle.png">
            <img id="mushroomIdleImage"
                src="mushroom/Idle.png">
            <img id="skeletonIdleImage"
                src="skeleton/Idle.png">
            <img id="slimeIdleImage"
                src="slime/Idle.png">

            <!-- Overview map -->
            <img id="map2Image"
                src="map.png">
            <img id="resistBar"
                src="GameFXexport/SPRITESHEET_Files/Explosion_3_133x133.png">

            <!-- Overview Icons -->
            <img id="room1Headshot"
                src="enemyWizard/Headshot.png">
            <img id="room2Headshot"
                src="flyingEye/Headshot.png">
            <img id="room3Headshot"
                src="mushroom/Headshot.png">
            <img id="room4Headshot"
                src="goblin/Headshot.png">
            <img id="room5Headshot"
                src="knight/Headshot.png">
            <img id="room6Headshot"
                src="archer/Headshot.png">
            <img id="room7Headshot"
                src="king/Headshot.png">
        
            <!-- Cross animation -->
            <img id="cross"
                src="cross.png">
        
        
            </div>



        <div class="page" oncontextmenu="return false">
            <canvas id="canvas1" width="1200" height="600"></canvas>
            <canvas id="canvas2" width="1200" height="600"></canvas>
            <canvas id="canvas3" width="1200" height="600"></canvas>
            
            <div class="overlay">
                <img id="fireIcon" class="spell"
                    src="spellIcons/fire.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Fire')"
                    ondragstart="return false;">
                <img id="iceIcon" class="spell"
                    src="spellIcons/ice.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Ice')"
                    ondragstart="return false;">
                <img id="airIcon" class="spell"
                    src="spellIcons/air.png"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"
                    onclick="entities.player.attack('Air')"
                    ondragstart="return false;">
            </div>

            <!--
            <div id="svgholder">
                <svg id="svg" width="1200" height="600" disabled>
                    <polygon id="fire" class="poly" points="190, 155, 190 251, 286 251, 286 155"
                    onclick="lineSegments[0].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="ice" class="poly" points="240 255, 240 351, 336 351, 336 255" 
                    onclick="lineSegments[1].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="air" class="poly" points="190 355, 190 451, 286 451, 286 355"
                    onclick="lineSegments[2].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>
                </svg>
            </div>
            -->

            <button onclick="gameWindow.pause();">Pause</button>
            <button onclick="gameWindow.resume();">Resume</button>
            <button onclick="Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.display = 'block';});">Enable attacks</button>
            <button id="nextButton">Next</button>
        </div>

        <div id="winScreen" class="modal">
            <div class="modal-content">
                <p>Thanks for playing! Please take a minute to answer our survey about your experience found <a id="surveyLink" href="">here</a></p>
            </div>
        </div>
        <div id="explanation" class="modal">
            <!-- Modal content -->
            <div class="modal-content explanation">
                <p class="hidden readable-tutorial" id="group1Explanation">Now that you know how it works - please rate on a scale from 1 (very unsure) to 10 (pretty certain) how confident you are that you will choose the right paths.</p>
                <p class="hidden readable-tutorial" id="group2Explanation">
                Before the game begins there will be a practice period where you can get a feeling for moving your cursor around the game board. All paths will be opened and there will be nothing to choose - this is simply movement practice.

                After 15 seconds you will get the option to start the game.
                </p>
                <p class="hidden readable-tutorial" id="group2Explanation2">Now that you know how it works - please rate on a scale from 1 (very unsure) to 10 (pretty certain) how confident you are that you will choose the right paths.</p>

                <div class="hidden" id="confidence" onclick="setConfidence()">
                    <p>not confident</p>
                    <label class="radio_button first" for="confidence1">
                        <span class="confidence_number">1</span>
                        <input type="radio" id="confidence1" name="confidence" value="1">
                    </label>
                    <label class="radio_button" for="confidence2">
                        <span class="confidence_number">2</span>
                        <input type="radio" id="confidence2" name="confidence" value="2">
                    </label>
                    <label class="radio_button" for="confidence3">
                        <span class="confidence_number">3</span>
                        <input type="radio" id="confidence3" name="confidence" value="3">
                    </label>
                    <label class="radio_button" for="confidence4">
                        <span class="confidence_number">4</span>
                        <input type="radio" id="confidence4" name="confidence" value="4">
                    </label>
                    <label class="radio_button" for="confidence5">
                        <span class="confidence_number">5</span>
                        <input type="radio" id="confidence5" name="confidence" value="5">
                    </label>
                    <label class="radio_button" for="confidence6">
                        <span class="confidence_number">6</span>
                        <input type="radio" id="confidence6" name="confidence" value="6">
                    </label>
                    <label class="radio_button" for="confidence7">
                        <span class="confidence_number">7</span>
                        <input type="radio" id="confidence7" name="confidence" value="7">
                    </label>
                    <label class="radio_button" for="confidence8">
                        <span class="confidence_number">8</span>
                        <input type="radio" id="confidence8" name="confidence" value="8">
                    </label>
                    <label class="radio_button" for="confidence9">
                        <span class="confidence_number">9</span>
                        <input type="radio" id="confidence9" name="confidence" value="9">
                    </label>
                    <label class="radio_button" for="confidence10">
                        <span class="confidence_number">10</span>
                        <input type="radio" id="confidence10" name="confidence" value="10">
                    </label>
                    <p>very confident</p>
                </div>
                <button onclick="closeExplanation()">Click here when you're done</button>
            </div>
        </div>
    </body>

    <script>
        /*
        var participantGroup = Math.floor(Math.random() * 2) + 1;
        var ready;
        if(participantGroup == 1) {
            document.getElementById("group1Explanation").style.display = "block";
            document.getElementById("tutorial").style.display = "flex";
            document.getElementById("confidence").style.display = "flex";
            ready = true;
        } else {
            document.getElementById("group2Explanation").style.display = "block";
            document.getElementById("tutorial").style.display = "flex";
            ready = false;
        }

        function setConfidence() {
            var rates = document.getElementsByName("confidence");
            var confidenceValue;
            for(var i = 0; i < rates.length; i++) {
                if(rates[i].checked) {
                    confidenceValue = rates[i].value;
                }
            }
            document.getElementById("surveyLink").href = "https://docs.google.com/forms/d/e/1FAIpQLSfa0Nt08lBclw7pM523cVVIdbdM2qIqvwJjWpevGgleaQ_FtQ/viewform?usp=pp_url&entry.755563979=" + participantGroup + "&entry.146232743=" + confidenceValue;
        }

        function closeExplanation() {
            document.getElementById("explanation").style.display = "none";
            if(!ready) {
                lineSegments.forEach(line => {
                    line.filled = true;
                });
                gameWindow.startCursorCheck();
                window.setTimeout(function(){
                    document.body.style.cursor = "default";
                    window.clearInterval(gameWindow.cursorCheck);
                    document.getElementById("tutorial").style.display = "none";
                    document.getElementById("group2Explanation").style.display = "none";
                    document.getElementById("explanation").style.display = "block";
                    document.getElementById("group2Explanation2").style.display = "block";
                    document.getElementById("confidence").style.display = "flex";
                    ready = true;
                }, 15000);
            } else {
                startGame();
            }
            updateGameArea();
        }
        */

        function startTutorial() {
            entities.player = new PlayerCharacter();
            gameWindow.start();
            entities.enemy = new Enemy("wizard", {x:231, y:190}, {x:400, y:400});
            //var testEnemyFlyingEye = new Enemy("flyingEye", {x:150, y:150}, {x:400, y:400});
            //var testEnemyGoblin = new Enemy("goblin", {x:150, y:150}, {x:400, y:400});
            //var testEnemySkeleton = new Enemy("skeleton", {x:150, y:150}, {x:400, y:400});
            //var testEnemyMushroom = new Enemy("mushroom", {x:150, y:150}, {x:400, y:400});
            //var testEnemySlime = new Enemy("slime", {x:32, y:25}, {x:400, y:400});
            //drawTextBox("this is a super long string that might fill more than the screen, especially if i keep adding dumb stuff like this and that, fuck still not long enough gotta keep going until i can't anymore and then keep going anyway. Somehow this wasn't enough so now i gotta add even more text just to try and fill out the stupid ass box");
            
            //Drawing overview map icons - just for testing
            gameWindow.context2.drawImage(document.getElementById("map2Image"), 0, 0);
            gameWindow.context2.drawImage(document.getElementById("room1Headshot"), 155, 40);
            gameWindow.context2.drawImage(document.getElementById("room2Headshot"), 295, 40);
            gameWindow.context2.drawImage(document.getElementById("room3Headshot"), 435, 40);
            gameWindow.context2.drawImage(document.getElementById("room4Headshot"), 570, 40);
            gameWindow.context2.drawImage(document.getElementById("room5Headshot"), 710, 40);
            gameWindow.context2.drawImage(document.getElementById("room6Headshot"), 855, 40);
            gameWindow.context2.drawImage(document.getElementById("room7Headshot"), 990, 40);

            //Drawing spell icons - just for testing
            
            //drawables["cross"] = new Animation(document.getElementById("cross"), 500, 300, {x:75, y:75}, {x:75, y:75}, Infinity, "cross", 10);
            //gameWindow.context2.drawImage(document.getElementById("fireIcon"), 100, 80);
            tutorialSteps[0].draw();
        }

        function startPractice() {

        }

        function prepareGame() {
            
        }

        function startGame() {
            
        }

        var drawables = {};
        var tutorialSteps = [];
        var entities = {};
        var gameWindow = {
            stopGame : false,
            canvas1 : document.getElementById("canvas1"),
            context1 : this.canvas1.getContext("2d"),
            canvas2 : document.getElementById("canvas2"),
            context2 : this.canvas2.getContext("2d"),
            canvas3 : document.getElementById("canvas3"),
            context3 : this.canvas3.getContext("2d"),

            start : function() {
                this.context1.webkitImageSmoothingEnabled = false;
                this.context1.mozImageSmoothingEnabled = false;
                this.context1.imageSmoothingEnabled = false;
                this.context1.msImageSmoothingEnabled = false;
                window.addEventListener('mousemove', function(e) {
                    var canvasRect = gameWindow.canvas1.getBoundingClientRect();
                    gameWindow.mouseX = e.clientX - canvasRect.left;
                    gameWindow.mouseY = e.clientY - canvasRect.top;
                });
                window.requestAnimationFrame(this.draw);
            },

            pause : function() {
                this.stopGame = true;
            },

            resume : function() {
                window.requestAnimationFrame(this.draw);
            },

            draw : function() {
                if (gameWindow.stopGame) {
                    gameWindow.stopGame = false;
                    return;
                }
                gameWindow.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                for (var key of Object.keys(drawables)) {
                    drawables[key].draw();
                }
                window.requestAnimationFrame(gameWindow.draw);
            }
        }

        class PlayerCharacter {
            constructor() {
                this.animationFrame = 0;
                this.frameSize = {x:231, y:190}
                this.size = {x:400, y:400}
                this.x = 100 - this.size.x / 2
                this.y = 300 - this.size.y / 2
                this.fps = 10;
                this.playerImage = document.getElementById("playerIdleImage");
                this.fireball = document.getElementById("fireball");
                this.icepick = document.getElementById("icepick");
                this.tornadoStatic = document.getElementById("tornadoStatic");
                this.tornadoLoop = document.getElementById("tornadoLoop");
                drawables["3-player"] = new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps);
            }

            attack(attackType) {
                var idle = getAnimation(new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps));

                Array.prototype.forEach.call(document.getElementsByClassName("spell"), function(icon) {icon.style.display = "none";});

                var attackHit = function() {
                    if (this.x > this.targetX) {
                        entities.enemy.hit(attackType);
                    }
                }
                switch (attackType) {
                    case "Fire":
                        var projectileAnimation = getAnimation(new MovingAnimation(this.fireball, 140, 160, 1000, 160, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        break;
                    case "Ice":
                        var projectileAnimation = getAnimation(new MovingAnimation(this.icepick, 150, 160, 980, 160, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                    break;
                    case "Air":
                        var tornadoLoopAnimation = getAnimation(new MovingAnimation(this.tornadoLoop, 560, 220, 1000, 220, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        var tornadoCallback = function() {
                            if (this.x > this.targetX) {
                                tornadoLoopAnimation();
                            }
                        } 
                        var projectileAnimation = getAnimation(new MovingAnimation(this.tornadoStatic, 100, 220, 550, 220, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, tornadoCallback));
                    break;
                    }
                var animation = function() {
                    if(this.currentCycle == this.cycles) {
                        idle();
                    }
                    if(this.animationFrame == 36) {
                        projectileAnimation();
                        sortDrawables();
                    }
                }
                drawables["3-player"] = new Animation(document.getElementById("playerAttack" + attackType + "Image") , this.x, this.y, this.frameSize, this.size, 1, "3-player", this.fps, animation);
            }
        }

        class Enemy {
            constructor(name, frameSize, size) {
                this.animationFrame = 0;
                this.frameSize = frameSize
                this.size = size
                this.x = 1100 - this.size.x / 2
                this.y = 300 - this.size.y / 2
                this.fps = 10;
                this.idleImage = document.getElementById(name + "IdleImage");
                this.attackImage = document.getElementById(name + "AttackImage");
                this.resistImage = document.getElementById(name + "ResistImage");
                this.deathImage = document.getElementById(name + "DeathImage");
                this.resistBarImage = document.getElementById("resistBar");
                drawables["1-enemy"] = new Animation(this.idleImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
            }

            hit(attackType) {
                // UNINTUITIVE: Play effect-animation in hit
                drawables["1-enemy"] = new Animation(this.resistImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
                var deathDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        this.freezeAnimation();
                        
                    }
                }
                var deathAnimation = getAnimation(new Animation(this.deathImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps, deathDone));
                var death = function() {
                    if(this.animationFrame == 120) {
                        this.delete();
                        deathAnimation();
                    }
                }
                drawables.resistBar = new Animation(this.resistBarImage, 500, 200, {x:133, y:133}, {x:200, y:200}, 1, "resistBar", 5, death);
            }
        }

        function getAnimation(animation) {
            return function() {
                drawables[animation.key] = animation;
            };
        }

        function sortDrawables() {
            drawables = Object.keys(drawables).sort().reduce(
                (obj, key) => { 
                    obj[key] = drawables[key]; 
                    return obj;
                }, {}
            );
        }

        class Animation {
            constructor(image, x, y, frameSize, size, cycles, key, fps, callBack) {
                this.image = image;
                this.x = x;
                this.y = y;
                this.frameSize = frameSize;
                this.size = size;
                this.animationFrame = 0;
                this.cycles = cycles;
                this.currentCycle = 0;
                this.key = key;
                this.callBack = callBack;
                this.wait = 60/fps;
                this.freeze = false;
            }
        
            draw() {
                //drawImage(image, dx, dy, dxWidth, dyHeight, x, y, xWidth, yHeight)
                gameWindow.context1.drawImage(this.image, this.frameSize.x * Math.floor(this.animationFrame / this.wait), 0, this.frameSize.x, this.frameSize.y, this.x, this.y, this.size.x, this.size.y);
                if(!this.freeze) {
                    this.animationFrame++;
                    if (this.animationFrame > this.image.width / this.frameSize.x * this.wait - 1) {
                        this.animationFrame = 0;
                        this.currentCycle++;
                    }
                    if (this.currentCycle >= this.cycles) {
                        this.delete();
                    }
                    if (this.callBack != undefined) {
                        this.callBack();
                    }
                }
            }

            delete() {
                delete drawables[this.key];
            }

            freezeAnimation() {
                this.freeze = true;
            }
        }

        class MovingAnimation extends Animation{
            constructor(image, x, y, targetX, targetY, frameSize, size, key, fps, lifetime, callBack) {
                super(image, x, y, frameSize, size, Infinity, key, fps, callBack);
                this.targetX = targetX;
                this.targetY = targetY;
                this.ratioX = (targetX - x) / lifetime;
                this.ratioY = (targetY - y) / lifetime;
            }

            draw() {
                if (this.x > this.targetX) {
                    this.delete();
                }
                super.draw();
                this.x += this.ratioX;
                this.y += this.ratioY;
            }
        }

        function highlightArea(area) {
            var ctx = gameWindow.context3;
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.beginPath();
            area();
            ctx.rect(1200, 0, -1200, 450);
            ctx.fill();
        }

        function drawTextBox(text) {
            var ctx = gameWindow.context3;
            ctx.font = "15px Arial";
            var lines = wrapText(ctx, text, 1100)
            ctx.fillStyle = "grey";
            ctx.beginPath();
            ctx.rect(0, 450, 1200, 150);
            ctx.fill();
            ctx.fillStyle = "white";
            var textY = 480;
            lines.forEach(line => {
                ctx.fillText(line, 50, textY);
                textY += 20;
            });
        }

        function wrapText(ctx, text, maxWidth) {
            var words = text.split(" ");
            var lines = [];
            var currentLine = words[0];

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                if (word == "\n") {
                    lines.push(currentLine);
                    i++;
                    while (words[i] == "\n") {
                        lines.push("");
                        i++;
                    }
                    currentLine = words[i];
                    continue;
                }
                var width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        class TutorialStep {
            constructor(area, text, nextFunction, pause) {
                this.area = area;
                this.text = text;
                this.pause = pause;
                this.nextFunction = nextFunction;
            }
            
            draw() {
                if (this.pause) {
                    gameWindow.pause();
                }
                gameWindow.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);
                if (this.area != undefined) {
                    highlightArea(this.area);
                }
                drawTextBox(this.text);
                document.getElementById("nextButton").onclick = this.nextFunction
            }
        }

        tutorialSteps.push(new TutorialStep(undefined, 'Welcome to One-Shot Wizard! \n My name is: The-Handy-Dandy-Tutorial-Text and I will now guide you through how to play the game - please click "next" to continue.', function() {tutorialSteps[1].draw();}, false));
        tutorialSteps.push(new TutorialStep(function() {gameWindow.context3.arc(85, 305, 100, 0, 2 * Math.PI)}, 'This is you', function() {tutorialSteps[2].draw();}, false));
        tutorialSteps.push(new TutorialStep(function() {gameWindow.context3.arc(1115, 305, 100, 0, 2 * Math.PI)}, 'This is your enemy. Each room will have one enemy.', function() {tutorialSteps[3].draw();}, false));
        tutorialSteps.push(new TutorialStep(function() {gameWindow.context3.arc(300, 300, 100, 0, 2 * Math.PI)}, 'To defeat an enemy you must choose an attack from the ones available - [Certain enemies are weak to certain attacks and it is up to you to figure out what attack will be effective on the enemy you are facing, based on subtle clues provided by the game. \n \n Choose wisely - because you only get ONE SHOT!]', function() {gameWindow.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);}, false));
        
    </script>
</html>
