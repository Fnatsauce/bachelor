<!DOCTYPE html>
<meta charset="UTF-8">
<html>
    <head>
        <title>game</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css"></link>
        <script src="lang.js"></script>
    </head>
    <body onload="startLanguageSelection()">
        <div style="display:none;">
            <!-- Player animations -->
            <img id="playerIdleImage"
                src="characters/PlayerCharacter/Idle.png">
            <img id="playerAttackFireImage"
                src="characters/PlayerCharacter/Attack2-fire.png">
            <img id="playerAttackIceImage"
                src="characters/PlayerCharacter/Attack2-ice.png">
            <img id="playerAttackAirImage"
                src="characters/PlayerCharacter/Attack1-air.png">
            <img id="playerDeathImage"
                src="characters/PlayerCharacter/Death.png">

            <!-- Player spell-attack animations -->
            <img id="fireball"
                src="GameFXexport/SPRITESHEET_Files/FireBall_64x64.png">
            <audio id="FireCast" controls="none"> 
                <source src="spells/FireCast.wav">
            </audio>
            <audio id="FireHit1" controls="none"> 
                <source src="spells/FireHit1.wav">
            </audio>
            <audio id="FireHit2" controls="none"> 
                <source src="spells/FireHit2.wav">
            </audio>

            <img id="icepick"
                src="GameFXexport/SPRITESHEET_Files/IcePick_64x64.png">
            <audio id="IceCast" controls="none"> 
                <source src="spells/IceCast.wav">
            </audio>
            <audio id="IceHit1" controls="none"> 
                <source src="spells/IceHit1.wav">
            </audio>
            <audio id="IceHit2" controls="none"> 
                <source src="spells/IceHit2.wav">
            </audio>

            <img id="tornadoStatic"
                src="GameFXexport/SPRITESHEET_Files/TornadoStatic_96x96.png">
            <img id="tornadoLoop"
                src="GameFXexport/SPRITESHEET_Files/TornadoLoop_96x96.png">
            <audio id="AirCast" controls="none"> 
                <source src="spells/AirCast.wav">
            </audio>
            <audio id="AirHit1" controls="none"> 
                <source src="spells/AirHit1.wav">
            </audio>

            <!-- Attack-hit-effect animations -->
            <img id="Fire-hit"
                src="GameFXexport/SPRITESHEET_Files/Explosion_96x96.png">

            <img id="Ice-hit"
                src="GameFXexport/SPRITESHEET_Files/IceShatter_96x96.png">
            
            <img id="Air-hit"
                src="GameFXexport/SPRITESHEET_Files/PoisonCast_96x96.png">
            <img id="TornadoLoop"
                src="GameFXexport/SPRITESHEET_Files/TornadoLoop_96x96.png">

            <!-- Enemies -->
            <audio id="resisting" controls="none">
                <source src="resisting.wav">
            </audio>
            
            <img id="wizardIdleImage"
                src="characters/enemyWizard/Idle.png">
            <img id="wizardResistImage"
                src="characters/enemyWizard/Hit.png">
            <img id="wizardDeathImage"
                src="characters/enemyWizard/Death.png">
            <audio id="wizardDeath" controls="none">
                <source src="characters/enemyWizard/wizardDeath.wav">
            </audio>
          
            <img id="flyingEyeIdleImage"
                src="characters/flyingEye/Idle.png">
            <img id="flyingEyeResistImage"
                src="characters/flyingEye/Hit.png">
            <img id="flyingEyeDeathImage"
                src="characters/flyingEye/Death.png">
            <audio id="flyingEyeDeath" controls="none"> 
                <source src="characters/flyingEye/flyingEyeDeath.wav">
            </audio>

            <img id="mushroomIdleImage"
                src="characters/mushroom/Idle.png">
            <img id="mushroomResistImage"
                src="characters/mushroom/Hit.png">
            <img id="mushroomDeathImage"
                src="characters/mushroom/Death.png">
            <audio id="mushroomDeath" controls="none"> 
                <source src="characters/mushroom/mushroomDeath.wav">
            </audio>

            <img id="goblinIdleImage"
                src="characters/goblin/Idle.png">
            <img id="goblinResistImage"
                src="characters/goblin/Hit.png">
            <img id="goblinDeathImage"
                src="characters/goblin/Death.png">
            <audio id="goblinDeath" controls="none"> 
                <source src="characters/goblin/goblinDeath.wav">
            </audio>

            <img id="skeletonIdleImage"
                src="characters/skeleton/Idle.png">
            <img id="skeletonResistImage"
                src="characters/skeleton/Hit.png">
            <img id="skeletonDeathImage"
                src="characters/skeleton/Death.png">
            <img id="skeletonAttackImage"
                src="characters/skeleton/Attack.png">
            <audio id="skeletonAttackStart" controls="none"> 
                <source src="characters/skeleton/skeletonAttackStart.wav">
            </audio>
            <audio id="skeletonDeath" controls="none"> 
                <source src="characters/skeleton/skeletonDeath.wav">
            </audio>

            <img id="slimeIdleImage"
                src="characters/slime/Idle.png">
            <img id="slimeResistImage"
                src="characters/slime/Hit.png">
            <img id="slimeAttackImage"
                src="characters/slime/Attack.png">
            <audio id="slimeAttackStart" controls="none"> 
                <source src="characters/slime/slimeAttackStart.wav">
            </audio>
            <audio id="slimeAttackStart" controls="none"> 
                <source src="characters/slime/slimeAttackStart.wav">
            </audio>

            <!-- Overview map -->
            <img id="tutorialMap"
                src="gui/tutorialMap.png">
            <img id="familiarityMap"
                src="gui/highFamMap.png">
            <img id="resistBar"
                src="resistBar.png">
            <img id="fade"
                src="fade.png">

            <!-- Text background -->
            <img id="textBackground"
                src="textBackground.png">
        
            <!-- Cross animation -->
            <img id="cross"
                src="gui/cross.png">

            <!-- Background music -->
            <audio id="backgroundMusic" controls="none"> 
                <source src="backgroundMusic.wav">
            </audio>
        </div>
        
        <!-- Background image -->
        <img id="backgroundImage" class="background"
            src="templeBackground.png"
            ondragstart="return false;">


        <div class="page" oncontextmenu="return false">
            <canvas id="canvas2" width="1200" height="600"></canvas>
            <canvas id="canvas1" width="1200" height="600"></canvas>
            <canvas id="canvas3" width="1200" height="600"></canvas>
            <div class="overlay">
                <div class="fireContainer">
                    <img id="fireIcon" class="spell"
                        src="spells/fire.png"
                        onmouseover="document.body.style.cursor = 'pointer'"
                        onmouseout="document.body.style.cursor = 'default'"
                        onclick="entities.player.attack('Fire')"
                        ondragstart="return false;">
                    <span id="fireTooltip" class="tooltip">Fireball</span>
                </div>
                <div class="iceContainer">
                    <img id="iceIcon" class="spell"
                        src="spells/ice.png"
                        onmouseover="document.body.style.cursor = 'pointer'"
                        onmouseout="document.body.style.cursor = 'default'"
                        onclick="entities.player.attack('Ice')"
                        ondragstart="return false;">
                    <span id="iceTooltip" class="tooltip">Ice Spear</span>
                </div>
                <div class="airContainer">
                    <img id="airIcon" class="spell"
                        src="spells/air.png"
                        onmouseover="document.body.style.cursor = 'pointer'"
                        onmouseout="document.body.style.cursor = 'default'"
                        onclick="entities.player.attack('Air')"
                        ondragstart="return false;">
                    <span id="airTooltip" class="tooltip">Tornado</span>
                </div>
                <img id="fadedSpells1" src="spells/fadedSpells1.png">
                <img id="fadedSpells2" src="spells/fadedSpells2.png">
                <input id="nextButton" type="image" src="gui/nextButtonUnpressed.png" name="nextButton" ondragstart="return false;" onmousedown="document.getElementById('nextButton').src = 'gui/nextButtonPressed.png'" onmouseup="document.getElementById('nextButton').src = 'gui/nextButtonUnpressed.png'"/>
            </div>
            <div class="bottom-overlay">
                <div class="volume-controls">
                    <div class="mute-container">
                        <input id="muteButton" type="checkbox" class="mute-button" onclick="toggleMuteAudio(this.checked)"><label></label></button>
                    </div>
                    <div class="volume-slider-container">
                        <input id="volumeSlider" type="range" oninput="changeVolume(this.value)" onchange="changeVolume(this.value)" min="0" max="0.4" step="0.02" value="0.1">
                    </div>
                    
                </div>

                <div class="credits">
                    <p>Pixal art by the following artists: <br>
                        LuizMelo: <a href="https://luizmelo.itch.io/">luizmelo.itch.io</a>, <br>
                        Oco: <a href="https://oco.itch.io/">oco.itch.io</a>, <br>
                        Szadi art: <a href="https://szadiart.itch.io/">szadiart.itch.io</a>, <br>
                        rvros: <a href="https://rvros.itch.io/">rvros.itch.io</a>, <br>
                        Quintinos Pixels: <a href="https://quintino-pixels.itch.io/">quintino-pixels.itch.io</a>, <br>
                        ppeldo: <a href="https://ppeldo.itch.io/">ppeldo.itch.io</a></p>
                    <p>Music by: Marllon Silva (xDeviruchi) - <a href="https://soundcloud.com/xdeviruchi">soundcloud.com/xdeviruchi</a></p>
                    <p>Sound effects by: harvey656 - <a href="https://harvey656.itch.io/">harvey656.itch.io</a></p>
                </div>
            </div>
        </div>

        <div id="explanation" class="modal">
            <!-- Modal content -->
            <div class="modal-content explanation">
                <div class="hidden readable-tutorial" id="languageSelection">
                    <p>Please select a language below.</p>
                    <p>Vælg et sprog herunder.</p>
                    <button onclick="setLanguage('dk')">Dansk</button>
                    <button onclick="setLanguage('en')">English</button>
                </div>
                <div class="hidden readable-tutorial" id="projectExplanation">
                    <p>Tak fordi du vil hjælpe os med vores projekt.</p>
                    <p>Thank you for wanting to help us with our project. </p>
                </div>
                <p class="hidden readable-tutorial" id="practiceExplanation"></p>
                <div class="hidden readable-tutorial" id="gameExplanation">
                    <img id="noIndicationMap"
                        src="gui/noIndicationMap.png">
                    <img id="indicationMap"
                        src="gui/gameMap.png">
                    <p id="gameExplanationText"></p>
                </div>
                <p class="hidden readable-tutorial" id="endOfGame"><a id="surveyLink" href=""> here</a></p>

                <div class="hidden" id="confidence" onclick="setConfidence()">
                    <p id="confidenceText1">not confident</p>
                    <label class="radio_button first" for="confidence1">
                        <span class="confidence_number">1</span>
                        <input type="radio" id="confidence1" name="confidence" value="1">
                    </label>
                    <label class="radio_button" for="confidence2">
                        <span class="confidence_number">2</span>
                        <input type="radio" id="confidence2" name="confidence" value="2">
                    </label>
                    <label class="radio_button" for="confidence3">
                        <span class="confidence_number">3</span>
                        <input type="radio" id="confidence3" name="confidence" value="3">
                    </label>
                    <label class="radio_button" for="confidence4">
                        <span class="confidence_number">4</span>
                        <input type="radio" id="confidence4" name="confidence" value="4">
                    </label>
                    <label class="radio_button" for="confidence5">
                        <span class="confidence_number">5</span>
                        <input type="radio" id="confidence5" name="confidence" value="5">
                    </label>
                    <label class="radio_button" for="confidence6">
                        <span class="confidence_number">6</span>
                        <input type="radio" id="confidence6" name="confidence" value="6">
                    </label>
                    <label class="radio_button" for="confidence7">
                        <span class="confidence_number">7</span>
                        <input type="radio" id="confidence7" name="confidence" value="7">
                    </label>
                    <label class="radio_button" for="confidence8">
                        <span class="confidence_number">8</span>
                        <input type="radio" id="confidence8" name="confidence" value="8">
                    </label>
                    <label class="radio_button" for="confidence9">
                        <span class="confidence_number">9</span>
                        <input type="radio" id="confidence9" name="confidence" value="9">
                    </label>
                    <label class="radio_button" for="confidence10">
                        <span class="confidence_number">10</span>
                        <input type="radio" id="confidence10" name="confidence" value="10">
                    </label>
                    <p id="confidenceText2">very confident</p>
                </div>
                <button class="hidden" id="explanationButton" onclick="closeExplanation()">Click here when you're done</button>
            </div>
        </div>
    </body>

    <script>

        /*--------------------------------------------------------------
        >>> TABLE OF CONTENTS:
        ----------------------------------------------------------------
        1.0 Sound
        2.0 
        3.0 
        4.0 
        5.0 
        6.0 
        --------------------------------------------------------------*/

        /*--------------------------------------------------------------
        1.0 Sound
        --------------------------------------------------------------*/

        var backgroundMusic = document.getElementById("backgroundMusic");

        function sound() {
            var sound = backgroundMusic;
            sound.setAttribute("preload", "auto");
            sound.setAttribute("controls", "none");
            sound.loop = true;
            sound.volume = document.getElementById("volumeSlider").value;
            sound.muted = document.getElementById("muteButton").checked;
            sound.play();
        }

        function changeVolume(value) {
            backgroundMusic.volume = value;
        }
 
        function toggleMuteAudio(checked){
            if (checked) {
                backgroundMusic.muted = true;
            } else {
                backgroundMusic.muted = false;
            }
        }

        function playSoundEffect(soundId) {
            var sound = document.getElementById(soundId);
            sound.volume = backgroundMusic.volume;
            sound.muted = backgroundMusic.muted;
            sound.play();
        }

        function playLoopedSoundEffect(soundId) {
            var sound = document.getElementById(soundId);
            sound.volume = backgroundMusic.volume;
            sound.muted = backgroundMusic.muted;
            sound.playbackRate = 1.5;
            sound.loop = true;
            sound.play();
        }

        /*--------------------------------------------------------------
        2.0 Game...
        --------------------------------------------------------------*/

        var participantGroup = Math.floor(Math.random() * 4) + 1;

        var participantGroup = 1;
        var confidenceRating;
        var language;

        function startTest() {
            language = "dk";
            gameWindow.start();
            entities.campaign = campaigns[4];
            entities.campaign.start();
            document.getElementById("explanationButton").style.display = "block";
        }

        function startLanguageSelection() {
            document.getElementById("languageSelection").style.display = "block";
            document.getElementById("explanation").style.display = "block";
        }

        function setLanguage(lang) {
            language = lang;
            document.getElementById("projectExplanation").innerHTML = explanationTexts[language].projectExplanation;
            document.getElementById("practiceExplanation").innerHTML = explanationTexts[language].practiceExplanation;
            document.getElementById("gameExplanationText").innerHTML = explanationTexts[language].gameExplanation;
            document.getElementById("confidenceText1").innerHTML = explanationTexts[language].confidenceText1;
            document.getElementById("confidenceText2").innerHTML = explanationTexts[language].confidenceText2;
            document.getElementById("explanationButton").innerHTML = explanationTexts[language].explanationButton;
            document.getElementById("endOfGame").insertBefore(document.createTextNode(explanationTexts[language].endOfGame), document.getElementById("surveyLink"));
            document.getElementById("surveyLink").innerHTML = explanationTexts[language].surveyLinkText;
            document.getElementById("fireTooltip").innerHTML = explanationTexts[language].fireball;
            document.getElementById("iceTooltip").innerHTML = explanationTexts[language].iceSpear;
            document.getElementById("airTooltip").innerHTML = explanationTexts[language].tornado;
            startTutorial();
        }

        function startTutorial() {
            document.getElementById("languageSelection").style.display = "none";
            document.getElementById("projectExplanation").style.display = "block";
            document.getElementById("explanationButton").style.display = "block";
            createTutorialsteps();
            gameWindow.start();
            gameWindow.tutorial = true;
            entities.campaign = campaigns[0];
            entities.campaign.start();
            Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "none";});
            gameWindow.context2.drawImage(document.getElementById("tutorialMap"), 0, 0);
            tutorialSteps[0].draw();       
        }

        function startPractice() {
            document.getElementById("projectExplanation").style.display = "none";
            document.getElementById("practiceExplanation").style.display = "block";
            document.getElementById("explanation").style.display = "block";
            entities.campaign = campaigns[1];
            entities.campaign.start();
            gameWindow.context2.drawImage(document.getElementById("familiarityMap"), 0, 0);
        }

        function startGame() {
            document.getElementById("projectExplanation").style.display = "none";
            document.getElementById("practiceExplanation").style.display = "none";
            document.getElementById("gameExplanation").style.display = "block";
            document.getElementById("confidence").style.display = "flex";
            document.getElementById("explanation").style.display = "block";
            document.getElementById("explanationButton").disabled = true;
            
            if(participantGroup < 3) {
                entities.campaign = campaigns[2];
                gameWindow.context2.drawImage(document.getElementById("noIndicationMap"), 0, 0);
                document.getElementById("indicationMap").style.display = "none";
            } else {
                entities.campaign = campaigns[3];
                gameWindow.context2.drawImage(document.getElementById("indicationMap"), 0, 0);
                document.getElementById("noIndicationMap").style.display = "none";
            }
            entities.campaign.start();
        }

        function endGame() {
            if(language == "en") {
                document.getElementById("surveyLink").href = "https://docs.google.com/forms/d/e/1FAIpQLScW7pIow1ME2T44PTCsdZLLxpKw7-IhxnPB4VgLXyh_rlDrfg/viewform?usp=pp_url&entry.755563979=" + participantGroup + "&entry.146232743=" + confidenceRating + "&entry.1854619726=" + spellsUsed;
            } else {
                document.getElementById("surveyLink").href = "https://docs.google.com/forms/d/e/1FAIpQLSe5CzlYNobcSaV1i-DrmyFRa2VN7YSjIX-023TDhy7hU1xB3w/viewform?usp=pp_url&entry.755563979=" + participantGroup + "&entry.146232743=" + confidenceRating + "&entry.1854619726=" + spellsUsed;
            }
            document.getElementById("gameExplanation").style.display = "none";
            document.getElementById("confidence").style.display = "none";
            document.getElementById("explanationButton").style.display = "none";
            document.getElementById("explanation").style.display = "block";
            document.getElementById("endOfGame").style.display = "block";
        }

        function closeExplanation() {
            document.getElementById("explanation").style.display = "none";
            if(backgroundMusic.volume == 1) {
                sound();
            }
        }

        function setConfidence() {
            var rates = document.getElementsByName("confidence");
            var confidenceValue;
            for(var i = 0; i < rates.length; i++) {
                if(rates[i].checked) {
                    confidenceValue = rates[i].value;
                }
            }
            confidenceRating = confidenceValue;
            document.getElementById("explanationButton").disabled = false;
        }
        function campaignFinished(campaign) {
            gameWindow.restart();
            if(campaign == 2) {
                if(participantGroup % 2 == 0) {
                    startPractice()
                } else {
                    startGame();
                }
            } else if(campaign == 7) {
                startGame();
            } else {
                endGame();
            }
        }

        var spellsUsed = "";
        var drawables = {};
        var tutorialSteps = [];
        var entities = {};
        var gameWindow = {
            tutorial : false,
            stopGame : false,
            gameRunning : true,
            canvas1 : document.getElementById("canvas1"),
            context1 : this.canvas1.getContext("2d"),
            canvas2 : document.getElementById("canvas2"),
            context2 : this.canvas2.getContext("2d"),
            canvas3 : document.getElementById("canvas3"),
            context3 : this.canvas3.getContext("2d"),

            start : function() {
                entities.player = new PlayerCharacter();
                this.context1.webkitImageSmoothingEnabled = false;
                this.context1.imageSmoothingEnabled = false;
                this.context1.msImageSmoothingEnabled = false;
                window.requestAnimationFrame(this.draw);
            },

            restart : function() {
                drawables = {};
                entities = {};
                entities.player = new PlayerCharacter();
                this.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.context2.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.context3.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                this.tutorial = false;
            },

            pause : function() {
                this.stopGame = true;
                this.gameRunning = false;
            },

            resume : function() {
                if(!this.gameRunning) {
                    this.gameRunning = true;
                    window.requestAnimationFrame(this.draw);
                }
            },

            draw : function() {
                if (gameWindow.stopGame) {
                    gameWindow.stopGame = false;
                    return;
                }
                gameWindow.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
                for (var key of Object.keys(drawables)) {
                    drawables[key].draw(gameWindow.context1);
                }
                window.requestAnimationFrame(gameWindow.draw);
            },

            clearText : function() {
                this.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);
                drawTextBox("");
            }
        }

        class PlayerCharacter {
            constructor() {
                this.animationFrame = 0;
                this.frameSize = {x:231, y:190};
                this.size = {x:400, y:400};
                this.x = 100 - this.size.x / 2;
                this.y = 340 - this.size.y / 2;
                this.fps = 10;
                this.playerImage = document.getElementById("playerIdleImage");
                this.fireball = document.getElementById("fireball");
                this.icepick = document.getElementById("icepick");
                this.tornadoStatic = document.getElementById("tornadoStatic");
                this.tornadoLoop = document.getElementById("tornadoLoop");
                drawables["3-player"] = new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps);
            }

            attack(attackType) {
                var idle = getAnimation(new Animation(this.playerImage, this.x, this.y, this.frameSize, this.size, Infinity, "3-player", this.fps));

                Array.prototype.forEach.call(document.getElementsByClassName("spell"), function(icon) {icon.style.display = "none";});

                var attackHit = function() {
                    if (this.x > this.targetX) {
                        entities.enemy.hit(attackType);
                    }
                }
                var sound = attackType + "Cast";
                switch (attackType) {
                    case "Fire":
                        spellsUsed += "1";
                        var projectileAnimation = getAnimation(new MovingAnimation(this.fireball, 140, 205, 970, 225, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        break;
                    case "Ice":
                        spellsUsed += "2";
                        var projectileAnimation = getAnimation(new MovingAnimation(this.icepick, 150, 205, 960, 225, {x:64, y:64}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        break;
                    case "Air":
                        spellsUsed += "3";
                        var tornadoLoopAnimation = getAnimation(new MovingAnimation(this.tornadoLoop, 560, 270, 1000, 270, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, attackHit));
                        var tornadoCallback = function() {
                            if (this.x > this.targetX) {
                                tornadoLoopAnimation();
                            }
                        } 
                        var projectileAnimation = getAnimation(new MovingAnimation(this.tornadoStatic, 100, 270, 550, 270, {x:96, y:96}, {x:200, y:200}, "2-playerAttack", 50, 50, tornadoCallback));
                        break;
                }
                var animation = function() {
                    if(this.currentCycle == this.cycles) {
                        idle();
                    }
                    if(this.animationFrame == 36) {
                        projectileAnimation();
                        playSoundEffect(sound);
                        sortDrawables();
                    }
                }
                drawables["3-player"] = new Animation(document.getElementById("playerAttack" + attackType + "Image") , this.x, this.y, this.frameSize, this.size, 1, "3-player", this.fps, animation);
            }

            getDeathAnimation(callBack) {
                var deathAnimation = getAnimation(new Animation(document.getElementById("playerDeathImage"), this.x, this.y, this.frameSize, this.size, 1, "3-player", this.fps, callBack));
                return deathAnimation;
            }
        }

        class Enemy {
            constructor(x, y, name, frameSize, size) {
                this.name = name;
                this.animationFrame = 0;
                this.frameSize = frameSize
                this.size = size;
                this.x = x;
                this.y = y;
                this.fps = 10;
                this.idleImage = document.getElementById(name + "IdleImage");
                this.attackImage = document.getElementById(name + "AttackImage");
                this.resistImage = document.getElementById(name + "ResistImage");
                this.deathImage = document.getElementById(name + "DeathImage");
                this.resistBarImage = document.getElementById("resistBar");
            }

            initialize() {
                drawables["1-enemy"] = new Animation(this.idleImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
                sortDrawables();
            }

            hit(attackType) {
                this.playHitEffectAnimation(attackType);
                drawables["1-enemy"] = new Animation(this.resistImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps);
                playLoopedSoundEffect("resisting");
                var deathDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        this.freezeAnimation();
                        if (gameWindow.tutorial) {
                            document.getElementById("nextButton").style.display = "block";
                            gameWindow.pause();
                            document.getElementById("resisting").pause();
                            document.getElementById("nextButton").disabled = false;
                        }
                        entities.campaign.nextRoom();
                    }
                }
                var deathAnimation = getAnimation(new Animation(this.deathImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps, deathDone));

                var playerDeathDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        this.freezeAnimation();
                        entities.campaign.nextRoom();
                    }
                }
                var playerDeathAnimation = entities.player.getDeathAnimation(playerDeathDone);
                var attackDone = function() {
                    if(this.animationFrame > this.image.width / this.frameSize.x * this.wait - 2) {
                        playerDeathAnimation();
                        playSoundEffect("wizardDeath");
                        entities.enemy.initialize();
                    }
                }
                var attackAnimation = getAnimation(new Animation(this.attackImage, this.x, this.y, this.frameSize, this.size, Infinity, "1-enemy", this.fps, attackDone));
                var resistTime = Math.floor(Math.random() * 479);
                var resist = function() {
                    if (this.animationFrame == 30 && gameWindow.tutorial && entities.enemy.name != "slime") {
                        gameWindow.pause();
                        document.getElementById("resisting").pause();
                        document.getElementById("nextButton").style.display = "block";
                        tutorialSteps[6].draw();
                    }
                    if(this.currentCycle >= this.cycles) {
                        delete drawables["2-TornadoLoop"];
                        document.getElementById("resisting").pause();
                        attackAnimation();
                        if (entities.enemy.name == "slime") {
                            playSoundEffect("slimeAttackStart");
                        } else {
                            setTimeout(function() {playSoundEffect("skeletonAttackStart");}, 500);
                        }
                        var ctx = gameWindow.context3;
                        ctx.font = "50px Arial";
                        ctx.fillStyle = "orange";
                        ctx.fillText("RESISTED", 920, 275);
                    }
                    if(this.animationFrame == resistTime) {
                        var attackingEnemies = ["slime", "skeleton"];
                        if(!(attackingEnemies.includes(entities.enemy.name) && (entities.campaign.currentRoom == entities.campaign.rooms.length - 1))) {
                            this.delete();
                            delete drawables["2-TornadoLoop"];
                            document.getElementById("resisting").pause();
                            deathAnimation();
                            playSoundEffect(entities.enemy.name + "Death");
                        }
                    }
                }
                drawables.resistBar = new Animation(this.resistBarImage, 1170, 310, {x:15, y:85}, {x:15, y:85}, 1, "resistBar", 5, resist);
            }

            playHitEffectAnimation(attackType) {
                switch (attackType) {
                    case "Fire":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 155, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 40);
                        playSoundEffect("FireHit1");
                        playSoundEffect("FireHit2");
                        break;
                    case "Ice":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 195, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 40);
                        playSoundEffect("IceHit1");
                        playSoundEffect("IceHit2");
                        break;
                    case "Air":
                        drawables["2-hitEffect"] = new Animation(document.getElementById(attackType + "-hit"), 990, 185, {x:96, y:96}, {x:250, y:250}, 1, "2-hitEffect", 70);
                        drawables["2-TornadoLoop"] = new Animation(document.getElementById("TornadoLoop"), 990, 235, {x:96, y:96}, {x:250, y:250}, Infinity, "2-TornadoLoop", 50);
                        playSoundEffect("AirHit1");
                        break;
                }
            }
        }

        

        function getAnimation(animation) {
            return function() {
                drawables[animation.key] = animation;
            };
        }

        function sortDrawables() {
            drawables = Object.keys(drawables).sort().reduce(
                (obj, key) => { 
                    obj[key] = drawables[key]; 
                    return obj;
                }, {}
            );
        }

        class Animation {
            constructor(image, x, y, frameSize, size, cycles, key, fps, callBack) {
                this.image = image;
                this.x = x;
                this.y = y;
                this.frameSize = frameSize;
                this.size = size;
                this.animationFrame = 0;
                this.cycles = cycles;
                this.currentCycle = 0;
                this.key = key;
                this.callBack = callBack;
                this.wait = 60/fps;
                this.freeze = false;
            }
        
            draw(context) {
                //drawImage(image, dx, dy, dxWidth, dyHeight, x, y, xWidth, yHeight)
                context.drawImage(this.image, this.frameSize.x * Math.floor(this.animationFrame / this.wait), 0, this.frameSize.x, this.frameSize.y, this.x, this.y, this.size.x, this.size.y);
                if(!this.freeze) {
                    this.animationFrame++;
                    if (this.animationFrame > this.image.width / this.frameSize.x * this.wait - 1) {
                        this.animationFrame = 0;
                        this.currentCycle++;
                    }
                    if (this.currentCycle >= this.cycles) {
                        this.delete();
                    }
                    if (this.callBack != undefined) {
                        this.callBack();
                    }
                }
            }

            delete() {
                delete drawables[this.key];
            }

            freezeAnimation() {
                this.freeze = true;
            }

            unfreezeAnimation() {
                this.freeze = false;
            }
        }

        class MovingAnimation extends Animation{
            constructor(image, x, y, targetX, targetY, frameSize, size, key, fps, lifetime, callBack) {
                super(image, x, y, frameSize, size, Infinity, key, fps, callBack);
                this.targetX = targetX;
                this.targetY = targetY;
                this.ratioX = (targetX - x) / lifetime;
                this.ratioY = (targetY - y) / lifetime;
            }

            draw(context) {
                if (this.x > this.targetX) {
                    this.delete();
                }
                super.draw(context);
                this.x += this.ratioX;
                this.y += this.ratioY;
            }
        }

        function highlightArea(area) {
            var ctx = gameWindow.context3;
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.beginPath();
            area();
            ctx.rect(1200, 0, -1200, 450);
            ctx.fill();
        }

        function drawTextBox(text) {
            var ctx = gameWindow.context3;
            ctx.drawImage(document.getElementById("textBackground"), 0, 450);
            ctx.font = "15px Arial";
            var lines = wrapText(ctx, text, 950)
            ctx.beginPath();
            ctx.fillStyle = "white";
            var textY = 490;
            lines.forEach(line => {
                ctx.fillText(line, 60, textY);
                textY += 20;
            });
        }

        function wrapText(ctx, text, maxWidth) {
            var words = text.split(" ");
            var lines = [];
            var currentLine = words[0];

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                if (word == "\n") {
                    lines.push(currentLine);
                    i++;
                    while (words[i] == "\n") {
                        lines.push("");
                        i++;
                    }
                    currentLine = words[i];
                    continue;
                }
                var width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        class Campaign {
            constructor(rooms, mapPortraitPosition) {
                this.rooms = rooms;
                this.currentRoom = 0;
                this.mapPortraitPosition = mapPortraitPosition
            }

            nextRoom() {
                this.currentRoom++;
                var fadeCallback;
                if(this.rooms.length > this.currentRoom) {
                    var crossCallback = function() {
                        if (this.currentCycle >= this.cycles) {
                            gameWindow.context2.drawImage(document.getElementById("cross"), 825, 0, 75, 75, entities.campaign.mapPortraitPosition + 140 * (entities.campaign.currentRoom - 1), 30, 75, 75);
                            drawables["8-fade"].unfreezeAnimation();
                        }
                    }
                    var cross = getAnimation(new Animation(document.getElementById("cross"), this.mapPortraitPosition + 140 * (this.currentRoom - 1), 30, {x:75, y:75}, {x:75, y:75}, 1, "9-cross", 15, crossCallback));
                    fadeCallback = function() {
                        if (this.animationFrame == 60) {
                            cross();
                            drawables["8-fade"].freeze = true;
                            entities.campaign.rooms[entities.campaign.currentRoom].prepareEnemy();
                        }
                        if (this.currentCycle >= this.cycles) {
                            gameWindow.clearText();
                            if (gameWindow.tutorial) {
                                tutorialSteps[9].draw();
                                document.getElementById("nextButton").style.display = "block";
                            } else {
                                entities.campaign.drawRoomText();
                            }
                            entities.campaign.rooms[entities.campaign.currentRoom].prepareSpells();
                        }
                    }
                } else {
                    fadeCallback = function() {
                        if (this.animationFrame == 1 && entities.campaign.currentRoom == 4 || entities.campaign.currentRoom == 1) { //todo: delete 1
                            var ctx = gameWindow.context3;
                            ctx.font = "100px Arial";
                            ctx.fillStyle = "red";
                            var width = ctx.measureText("Game Over").width;
                            ctx.fillText("Game Over", 600 - width / 2, 330);
                            backgroundMusic.muted = true;
                        }
                        if (this.animationFrame == 60) {
                            drawables["8-fade"].freeze = true;
                            if (gameWindow.tutorial) {
                                campaignFinished(entities.campaign.currentRoom);
                            } else {
                                setTimeout(function() {campaignFinished(entities.campaign.currentRoom);}, 4000);
                            }
                        }
                    }
                }
                if (!gameWindow.tutorial) {
                    gameWindow.clearText();
                }
                drawables["8-fade"] = new Animation(document.getElementById("fade"), 0, 150, {x:1, y:1}, {x:1200, y:450}, 1, "8-fade", 10, fadeCallback);
            }

            start() {
                this.rooms[this.currentRoom].prepareEnemy();
                this.rooms[this.currentRoom].prepareSpells();
                this.drawRoomText();
            }

            drawRoomText() {
                var approach = approaches[language][/* cycle through: */ this.currentRoom % 5 /* random: Math.floor(Math.random() * 5) */];
                drawTextBox(enemyNames[language][entities.enemy.name] + approach);
            }
        }

        class Room {
            constructor(enemy, unavailableSpell) {
                this.enemy = enemy;
                this.unavailableSpell = unavailableSpell;
            }

            prepareEnemy() {
                entities.enemy = this.enemy;
                this.enemy.initialize();
            }

            prepareSpells() {
                Array.prototype.forEach.call(document.getElementsByClassName("spell"), function(icon) {icon.style.display = "block";});
                if(this.unavailableSpell != undefined) {
                    document.getElementById(this.unavailableSpell + "Icon").style.display = "none";
                }
            }
        }

        var campaigns = [
            new Campaign([
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(980, 240, "slime", {x:32, y:25}, {x:200, y:200}), "ice")
            ], 493),
            new Campaign([
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "fire"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), "ice"),
                new Room(new Enemy(910, 140, "wizard", {x:231, y:190}, {x:400, y:400}), undefined),
            ], 144),
            new Campaign([
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "ice"),
            ], 144),
            new Campaign([
                new Room(new Enemy(870, 100, "mushroom", {x:150, y:150}, {x:500, y:500}), undefined),
                new Room(new Enemy(910, 160, "flyingEye", {x:150, y:150}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 160, "goblin", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "ice")
            ], 144),
            new Campaign([
            new Room(new Enemy(870, 100, "mushroom", {x:150, y:150}, {x:500, y:500}), undefined),
                new Room(new Enemy(910, 160, "flyingEye", {x:150, y:150}, {x:400, y:400}), "air"),
                new Room(new Enemy(910, 160, "goblin", {x:150, y:150}, {x:400, y:400}), undefined),
                new Room(new Enemy(910, 160, "skeleton", {x:150, y:150}, {x:400, y:400}), "ice")
            ], 144)
        ];

        /*--------------------------------------------------------------
        ?.0 Tutorial steps
        --------------------------------------------------------------*/

        class TutorialStep {
            constructor(area, text, nextFunction, pause) {
                this.area = area;
                this.text = text;
                this.pause = pause;
                this.nextFunction = nextFunction;
            }
            
            draw() {
                if (this.pause) {
                    gameWindow.pause();
                }
                gameWindow.context3.clearRect(0, 0, gameWindow.canvas3.width, gameWindow.canvas3.height);
                if (this.area != undefined) {
                    highlightArea(this.area);
                }
                drawTextBox(this.text);
                document.getElementById("nextButton").onclick = this.nextFunction
            }
        }

        function createTutorialsteps() {
            tutorialSteps.push( new TutorialStep(
                undefined, 
                tutorialTexts[language][0], 
                function() {document.getElementById("fadedSpells1").style.display = "block"; tutorialSteps[1].draw();}, false)
            );
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.arc(85, 345, 100, 0, 2 * Math.PI)}, 
                tutorialTexts[language][1], 
                function() {tutorialSteps[2].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.arc(1115, 345, 100, 0, 2 * Math.PI)}, 
                tutorialTexts[language][2], 
                function() {document.getElementById("fadedSpells1").style.display = "none"; tutorialSteps[3].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.ellipse(240, 300, 120, 170, 0, 0, 2 * Math.PI)}, 
                tutorialTexts[language][3], 
                function() {document.getElementById("fadedSpells1").style.display = "block"; tutorialSteps[4].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.arc(1115, 345, 100, 0, 2 * Math.PI)}, 
                tutorialTexts[language][4], 
                function() {
                    document.getElementById("fadedSpells1").style.display = "none"; 
                    Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "auto"; document.getElementById("nextButton").style.display = "none";}); 
                    tutorialSteps[5].draw();
                }, false
            ));
            tutorialSteps.push(new TutorialStep(undefined, tutorialTexts[language][5], function() {return}, false));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.ellipse(1178, 350, 20, 60, 0, 0, 2 * Math.PI)}, 
                tutorialTexts[language][6], 
                function() {gameWindow.resume(); tutorialSteps[7].draw(); document.getElementById("nextButton").style.display = "none";}, false
            ));
            tutorialSteps.push(new TutorialStep(undefined, "...", function() {tutorialSteps[8].draw();}, false));
            tutorialSteps.push(new TutorialStep(
                undefined, 
                tutorialTexts[language][7], 
                function() {Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "none";}); gameWindow.clearText(); gameWindow.resume(); document.getElementById("nextButton").style.display = "none";}, false
            ));
            // Transition to the next room!
            tutorialSteps.push(new TutorialStep(
                undefined, 
                tutorialTexts[language][8], 
                function() {document.getElementById("fadedSpells2").style.display = "block"; tutorialSteps[10].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.arc(1100, 385, 100, 0, 2 * Math.PI)}, 
                tutorialTexts[language][9], 
                function() {document.getElementById("fadedSpells2").style.display = "none"; tutorialSteps[11].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                undefined, 
                tutorialTexts[language][10], 
                function() {tutorialSteps[12].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.ellipse(240, 300, 120, 170, 0, 0, 2 * Math.PI)}, 
                tutorialTexts[language][11], 
                function() {document.getElementById("fadedSpells2").style.display = "block"; tutorialSteps[13].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                function() {gameWindow.context3.ellipse(600, 75, 200, 75, 0, 0, 2 * Math.PI)}, 
                tutorialTexts[language][12], 
                function() {Array.prototype.forEach.call(document.getElementsByClassName('spell'), function(icon) {icon.style.pointerEvents = "auto";}); document.getElementById("fadedSpells2").style.display = "none"; document.getElementById("nextButton").style.display = "none"; tutorialSteps[14].draw();}, false
            ));
            tutorialSteps.push(new TutorialStep(
                undefined, 
                tutorialTexts[language][13], 
                function() {}, false
            ));
        }
    </script>
</html>
