<!DOCTYPE html>
<html>
    <head>
        <title>game</title>
        <link rel="stylesheet" type="text/css" href="stylesheet.css"></link>
    </head>
    <body onload="prepareGame()">
        <div style="display:none;">
            <img id="cursorImage"
                 src="cursor.png">
            <img id="foregroundImage"
                src="foreground.png">
        </div>
        <div class="page">
            <canvas id="canvas1" width="1200" height="600"></canvas>
            <canvas id="canvas2" width="1200" height="600"></canvas>

            <div id="svgholder">
                <svg id="svg" width="1200" height="600" disabled>
                    <polygon id="poly0" class="poly" points="28 96, 62 155, 93 135, 55 75"
                    onclick="lineSegments[0].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="poly1" class="poly" points="33 283, 33 319, 100 319, 100 283"
                    onclick="lineSegments[1].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="poly2" class="poly" points="28 502, 55 527, 93 467, 62 447"
                    onclick="lineSegments[2].fill(); gameWindow.startCursorCheck()"
                    onmouseover="document.body.style.cursor = 'pointer'"
                    onmouseout="document.body.style.cursor = 'default'"></polygon>

                    <polygon id="poly3" class="poly" points="178 266, 198 298, 228 250, 208 216"
                    onmouseover="lineSegments[3].fill()"></polygon>

                    <polygon id="poly4" class="poly" points="178 338, 208 385, 228 352, 198 302"
                    onmouseover="lineSegments[4].fill()"></polygon>

                    <polygon id="poly5" class="poly" points="313 82, 333 117, 359 117, 349 82"
                    onmouseover="lineSegments[5].fill()"></polygon>

                    <polygon id="poly6" class="poly" points="330 123, 301 141, 323 186, 350 163"
                    onmouseover="lineSegments[6].fill()"></polygon>

                    <polygon id="poly7" class="poly" points="300 461, 332 478, 350 440, 323 413"
                    onmouseover="lineSegments[7].fill()"></polygon>
                    
                    <polygon id="poly8" class="poly" points="333 482, 301 519, 353 519, 353 482"
                    onmouseover="lineSegments[8].fill()"></polygon>

                    <polygon id="poly9" class="poly" points="453 155, 475 192, 488 166, 465 131"
                    onmouseover="lineSegments[9].fill()"></polygon>

                    <polygon id="poly10" class="poly" points="471 205, 449 235, 462 262, 487 236"
                    onmouseover="lineSegments[10].fill()"></polygon>

                    <polygon id="poly11" class="poly" points="452 354, 473 395, 489 363, 466 329"
                    onmouseover="lineSegments[11].fill()"></polygon>

                    <polygon id="poly12" class="poly" points="472 402, 453 445, 468 475, 487 437"
                    onmouseover="lineSegments[12].fill()"></polygon>

                    <polygon id="poly13" class="poly" points="604 252, 632 275, 647 246, 620 222"
                    onmouseover="lineSegments[13].fill()"></polygon>

                    <polygon id="poly14" class="poly" points="633 282, 633 318, 660 318, 660 282"
                    onmouseover="lineSegments[14].fill()"></polygon>

                    <polygon id="poly15" class="poly" points="630 322, 603 346, 619 379, 645 353"
                    onmouseover="lineSegments[15].fill()"></polygon>

                    <polygon id="poly16" class="poly" points="668 123, 698 147, 706 131, 675 109"
                    onmouseover="lineSegments[16].fill()"></polygon>

                    <polygon id="poly17" class="poly" points="697 155, 677 194, 687 213, 705 172"
                    onmouseover="lineSegments[17].fill()"></polygon>

                    <polygon id="poly18" class="poly" points="741 378, 758 384, 772 399, 787 370, 756 352"
                    onmouseover="lineSegments[18].fill()"></polygon>
                
                    <polygon id="poly19" class="poly" points="773 408, 755 447, 766 473, 790 441"
                    onmouseover="lineSegments[19].fill()"></polygon>

                    <polygon id="poly20" class="poly" points="1004 252, 1032 275, 1047 246, 1020 222"
                    onmouseover="lineSegments[20].fill()"></polygon>

                    <polygon id="poly21" class="poly" points="1033 282, 1033 318, 1060 318, 1060 282"
                    onmouseover="lineSegments[21].fill()"></polygon>

                    <polygon id="poly22" class="poly" points="1030 322, 1003 346, 1019 379, 1045 353"
                    onmouseover="lineSegments[22].fill()"></polygon>
                </svg>
            </div>
        </div>

        <div id="winScreen" class="modal">
            <div class="modal-content">
                <p>Thanks for playing! Please take a minute to answer our survey about your experience found <a id="surveyLink" href="">here</a></p>
            </div>
        </div>
        <div id="explanation" class="modal">
            <!-- Modal content -->
            <div class="modal-content explanation">
                <div class="holder hidden" id="tutorial">
                    <div id="tutorial-text">Thank you for wanting to try out Paths! <br/>
                        <br/>
                        How to play: 
                        <br/> <br/>
                        There are three initial paths that can start your journey, as seen in the top image. One of them has been set up to sound a gentle buzzer. 
                        <br/> <br/>
                        Once a path has been chosen it will slowly crawl towards the next intersection over a timespan of 8 seconds. If it takes the full 8 seconds for the path to reach the intersection, no buzzer will sound which means you lost the game. 
                        <br/>
                        If the path suddenly springs forward to the next intersection before 8 seconds has passed, the buzzer will sound, which means you chose right will be able to move on.
                        <br/> <br/>
                        In the bottom image, a player has chosen correctly at the first two marked intersections, and is about to choose a new path at the third.

                        Your goal is to choose the path that will engage the buzzer at each intersection, all the way to the end of the maze-like game board.
                    <br/></div>
                    <div class="image-holder">
                        <img class="first-image" src="first.png" alt="This is where the first image would be, if it wasn't missing">
                        <img class="second-image" src="second.png" alt="This is where the first image would be, if it wasn't missing">
                    </div>
                </div>
                <p class="hidden readable-tutorial" id="group1Explanation">Now that you know how it works - please rate on a scale from 1 (very unsure) to 10 (pretty certain) how confident you are that you will choose the right paths.</p>
                <p class="hidden readable-tutorial" id="group2Explanation">
                Before the game begins there will be a practice period where you can get a feeling for moving your cursor around the game board. All paths will be opened and there will be nothing to choose - this is simply movement practice.

                After 15 seconds you will get the option to start the game.
                </p>
                <p class="hidden readable-tutorial" id="group2Explanation2">Now that you know how it works - please rate on a scale from 1 (very unsure) to 10 (pretty certain) how confident you are that you will choose the right paths.</p>

                <div class="hidden" id="confidence" onclick="setConfidence()">
                    <p>not confident</p>
                    <label class="radio_button first" for="confidence1">
                        <span class="confidence_number">1</span>
                        <input type="radio" id="confidence1" name="confidence" value="1">
                    </label>
                    <label class="radio_button" for="confidence2">
                        <span class="confidence_number">2</span>
                        <input type="radio" id="confidence2" name="confidence" value="2">
                    </label>
                    <label class="radio_button" for="confidence3">
                        <span class="confidence_number">3</span>
                        <input type="radio" id="confidence3" name="confidence" value="3">
                    </label>
                    <label class="radio_button" for="confidence4">
                        <span class="confidence_number">4</span>
                        <input type="radio" id="confidence4" name="confidence" value="4">
                    </label>
                    <label class="radio_button" for="confidence5">
                        <span class="confidence_number">5</span>
                        <input type="radio" id="confidence5" name="confidence" value="5">
                    </label>
                    <label class="radio_button" for="confidence6">
                        <span class="confidence_number">6</span>
                        <input type="radio" id="confidence6" name="confidence" value="6">
                    </label>
                    <label class="radio_button" for="confidence7">
                        <span class="confidence_number">7</span>
                        <input type="radio" id="confidence7" name="confidence" value="7">
                    </label>
                    <label class="radio_button" for="confidence8">
                        <span class="confidence_number">8</span>
                        <input type="radio" id="confidence8" name="confidence" value="8">
                    </label>
                    <label class="radio_button" for="confidence9">
                        <span class="confidence_number">9</span>
                        <input type="radio" id="confidence9" name="confidence" value="9">
                    </label>
                    <label class="radio_button" for="confidence10">
                        <span class="confidence_number">10</span>
                        <input type="radio" id="confidence10" name="confidence" value="10">
                    </label>
                    <p>very confident</p>
                </div>
                <button onclick="closeExplanation()">Click here when you're done</button>
            </div>
        </div>
    </body>

    <script>
        var participantGroup = Math.floor(Math.random() * 2) + 1;
        //participantGroup = 1;
        var ready;
        if(participantGroup == 1) {
            document.getElementById("group1Explanation").style.display = "block";
            document.getElementById("tutorial").style.display = "flex";
            document.getElementById("confidence").style.display = "flex";
            ready = true;
        } else {
            document.getElementById("group2Explanation").style.display = "block";
            document.getElementById("tutorial").style.display = "flex";
            ready = false;
        }

        function setConfidence() {
            var rates = document.getElementsByName("confidence");
            var confidenceValue;
            for(var i = 0; i < rates.length; i++) {
                if(rates[i].checked) {
                    confidenceValue = rates[i].value;
                }
            }
            document.getElementById("surveyLink").href = "https://docs.google.com/forms/d/e/1FAIpQLSfa0Nt08lBclw7pM523cVVIdbdM2qIqvwJjWpevGgleaQ_FtQ/viewform?usp=pp_url&entry.755563979=" + participantGroup + "&entry.146232743=" + confidenceValue;
        }

        function closeExplanation() {
            document.getElementById("explanation").style.display = "none";
            if(!ready) {
                lineSegments.forEach(line => {
                    line.filled = true;
                });
                gameWindow.startCursorCheck();
                window.setTimeout(function(){
                    document.body.style.cursor = "default";
                    window.clearInterval(gameWindow.cursorCheck);
                    document.getElementById("tutorial").style.display = "none";
                    document.getElementById("group2Explanation").style.display = "none";
                    document.getElementById("explanation").style.display = "block";
                    document.getElementById("group2Explanation2").style.display = "block";
                    document.getElementById("confidence").style.display = "flex";
                    ready = true;
                }, 15000);
            } else {
                startGame();
            }
            updateGameArea();
        }

        function prepareGame() {
            gameWindow.start();
            initializeLineSegments();
            var canvas2 = document.getElementById("canvas2");
            canvas2.getContext("2d").drawImage(document.getElementById('foregroundImage'), 0, 0);
            updateGameArea();
        }

        function startGame() {
            lineSegments.forEach(line => {
                line.filled = false;
            });
            var poly = document.getElementsByClassName("poly");
            for(var i = 0; i < poly.length; i++) {
                poly[i].disabled = false;
            }
        }

        const cursorImage = document.getElementById('cursorImage');
        var currentLineSegment = 4
        var lineSegments = []
        var gameWindow = {
            canvas1 : document.getElementById("canvas1"),

            start : function() {
                this.context1 = this.canvas1.getContext("2d");

                window.addEventListener('mousemove', function(e) {
                    var canvasRect = gameWindow.canvas1.getBoundingClientRect();
                    gameWindow.mouseX = e.clientX - canvasRect.left;
                    gameWindow.mouseY = e.clientY - canvasRect.top;
                });
            },

            startCursorCheck : function() {
                this.cursorCheck = window.setInterval(checkCursor, 100);
            },

            clear : function() {
                this.context1.clearRect(0, 0, this.canvas1.width, this.canvas1.height);
            },

            draw : function() {
                this.context1.fillStyle = "#5B5B5B"
                this.context1.fillRect(0, 0, canvas1.width, canvas1.height);
            }
        }

        function checkCursor() {
            for(var j = 0; j < lineSegments.length; j++) {
                
                if(lineSegments[j].filled) {
                    let points = lineSegments[j].points
                    for(var i = 1; i < points.length; i++) {
                        if(pointOnLine(points[i - 1], points[i], {x:gameWindow.mouseX, y:gameWindow.mouseY})) {
                            document.body.style.cursor = "pointer";
                            return;
                        }
                    }
                }
            }
            document.body.style.cursor = "not-allowed";
        }

        function pointOnLine(linePoint1, linePoint2, point) {
            let top = (linePoint2.x - linePoint1.x) * (linePoint1.y - point.y) - (linePoint1.x - point.x) * (linePoint2.y - linePoint1.y)
            let distance = Math.abs(top)/Math.sqrt(Math.pow(linePoint2.x - linePoint1.x, 2) + Math.pow(linePoint2.y - linePoint1.y, 2));
            if(
                distance < 17.5 &&
                Math.min(linePoint1.x, linePoint2.x) - 17.5 < point.x &&
                Math.max(linePoint1.x, linePoint2.x) + 17.5 > point.x &&
                Math.min(linePoint1.y, linePoint2.y) - 17.5 < point.y &&
                Math.max(linePoint1.y, linePoint2.y) + 17.5 > point.y
            ) {
                return true;
            }
            return false;
        }

        function updateGameArea() {
            gameWindow.clear();
            gameWindow.draw();
            lineSegments.forEach(element => {
                element.draw();
                element.hovered();
            });
        }

        function lineSegment(points, id, next) {
            this.id = id;
            this.points = points;
            this.length = [];
            this.linesfilled = 0;
            this.lineIncrement = 0;
            this.filled = false;
            this.color = "#FFFFFF";
            this.next = next;
            this.canBeChosen = false;
            ctx = gameWindow.context1;
            for(var i = 1; i < points.length; i++) {
                this.length.push(Math.sqrt(Math.pow(this.points[i].x - this.points[i-1].x, 2) + Math.pow(this.points[i].y - this.points[i-1].y, 2)));
            }

            this.draw = function() {
                for(var i = 1; i < points.length; i++) {
                    if(this.filled) {
                        ctx.strokeStyle = this.color;
                        ctx.lineCap = "round";
                        this.drawLine(points[i - 1], points[i]);
                    }
                }
            }

            this.drawLine = function(point1, point2) {
                ctx.lineWidth = 35;
                ctx.lineJoin = "round";
                ctx.beginPath();
                ctx.moveTo(point1.x, point1.y);
                ctx.lineTo(point2.x, point2.y);
                ctx.stroke();
                ctx.closePath();
            }

            this.fill = function() {
                if(this.canBeChosen) {
                    currentLineSegment = this.id;
                    start = undefined;
                    animationStop = Math.floor(Math.random() * 8000);
                    lineSegments.forEach(line => {
                        line.canBeChosen = false;
                    });
                    updateGameArea();
                    window.requestAnimationFrame(animateLine);
                }
            }

            this.hovered = function() {
                if(this.canBeChosen) {
                    var x, y
                    if([0, 1, 2].includes(this.id)) {
                        x = points[0].x - (40/this.length[0]) * (points[1].x - points[0].x);
                        y = points[0].y - (40/this.length[0]) * (points[1].y - points[0].y);
                    } else {
                        x = points[0].x;
                        y = points[0].y;
                    }
                    var x2 = points[0].x + (40/this.length[0]) * (points[1].x - points[0].x);
                    var y2 = points[0].y + (40/this.length[0]) * (points[1].y - points[0].y);
                    ctx.strokeStyle = "#FFFFFF";
                    ctx.lineCap = "round";
                    this.drawLine({x:x, y:y}, {x:x2, y:y2});
                }
            }
        }

        let start;
        let animationStop;
        function animateLine(timestamp) {
            if (start === undefined)
                start = timestamp;
            const elapsed = timestamp - start;

            var ratio = (100/8000) * elapsed;
            var linesDrawn = lineSegments[currentLineSegment].linesfilled;
            var lengths = lineSegments[currentLineSegment].length;
            var fullLength = lengths.reduce(((acc, num) => acc + num), 0);
            var points = lineSegments[currentLineSegment].points;

            ctx.strokeStyle = "#FFFFFF";
            ctx.lineCap = "round";
            for(var i = 0; i < linesDrawn; i++) {
                ratio -= (lengths[i]/fullLength*100);
                lineSegments[currentLineSegment].drawLine(points[i], points[i + 1]);
            }

            fullRatio = ratio/(lengths[linesDrawn]/fullLength*100);

            var x = points[linesDrawn].x + fullRatio * (points[linesDrawn + 1].x - points[linesDrawn].x);
            var y = points[linesDrawn].y + fullRatio * (points[linesDrawn + 1].y - points[linesDrawn].y);

            lineSegments[currentLineSegment].drawLine(points[linesDrawn], {x:x, y:y});

            if(ratio > (lengths[linesDrawn]/fullLength)*100) {
                lineSegments[currentLineSegment].linesfilled++;
            }

            if(pointOnLine(points[linesDrawn], {x:x, y:y}, {x:gameWindow.mouseX, y:gameWindow.mouseY})) {
                document.body.style.cursor = "pointer";
            }

            if (elapsed < animationStop) { // Stop the animation after a random amount between 0-8 seconds
                window.requestAnimationFrame(animateLine);
            } else {
                lineSegments[currentLineSegment].filled = true;
                var audio = new Audio('pling.wav');
                audio.play();
                if(lineSegments[currentLineSegment].next.length < 1) {
                    document.getElementById("winScreen").style.display = "block";
                    window.clearInterval(gameWindow.cursorCheck);
                    document.body.style.cursor = "default";
                } else {
                    lineSegments[currentLineSegment].next.forEach(element => {
                        lineSegments[element].canBeChosen = true;
                    });
                }
                updateGameArea();
            }
        }

        function initializeLineSegments() {
            lineSegments.push(new lineSegment([{x:50,y:100},{x:175,y:300}], 0, [3, 4]));
            lineSegments[0].canBeChosen = true;
            lineSegments.push(new lineSegment([{x:50,y:300},{x:175,y:300}], 1, [3, 4]));
            lineSegments[1].canBeChosen = true;
            lineSegments.push(new lineSegment([{x:50,y:500},{x:175,y:300}], 2, [3, 4]));
            lineSegments[2].canBeChosen = true;
            lineSegments.push(new lineSegment([{x:175,y:300},{x:300,y:100}], 3, [5, 6]));
            lineSegments.push(new lineSegment([{x:175,y:300},{x:300,y:500}], 4, [7, 8]));
            lineSegments.push(new lineSegment([{x:300,y:100},{x:400,y:100},{x:450,y:200}], 5, [9, 10]));
            lineSegments.push(new lineSegment([{x:300,y:100},{x:400,y:300},{x:450,y:400}], 6, [11, 12]));
            lineSegments.push(new lineSegment([{x:300,y:500},{x:400,y:300},{x:450,y:400}], 7, [11, 12]));
            lineSegments.push(new lineSegment([{x:300,y:500},{x:400,y:500},{x:450,y:400}], 8, [11, 12]));
            lineSegments.push(new lineSegment([{x:450,y:200},{x:500,y:100},{x:600,y:300}], 9, [13, 14, 15]));
            lineSegments.push(new lineSegment([{x:450,y:200},{x:500,y:300},{x:600,y:300}], 10, [13, 14, 15]));
            lineSegments.push(new lineSegment([{x:450,y:400},{x:500,y:300},{x:600,y:300}], 11, [13, 14, 15]));
            lineSegments.push(new lineSegment([{x:450,y:400},{x:500,y:500},{x:600,y:300}], 12, [13, 14, 15]));
            lineSegments.push(new lineSegment([{x:600,y:300},{x:675,y:150}], 13, [16, 17]));
            lineSegments.push(new lineSegment([{x:600,y:300},{x:650,y:300},{x:700,y:400},{x:750,y:400}], 14, [18, 19]));
            lineSegments.push(new lineSegment([{x:600,y:300},{x:700,y:500},{x:750,y:400}], 15, [18, 19]));
            lineSegments.push(new lineSegment([{x:675,y:150},{x:700,y:100},{x:725,y:125},{x:900,y:125},{x:1000,y:300}], 16, [20, 21, 22]));
            lineSegments.push(new lineSegment([{x:675,y:150},{x:700,y:200},{x:850,y:200},{x:900,y:300},{x:1000,y:300}], 17, [20, 21, 22]));
            lineSegments.push(new lineSegment([{x:750,y:400},{x:800,y:300},{x:1000,y:300}], 18, [20, 21, 22]));
            lineSegments.push(new lineSegment([{x:750,y:400},{x:800,y:500},{x:900,y:500},{x:1000,y:300}], 19, [20, 21, 22]));
            lineSegments.push(new lineSegment([{x:1000,y:300},{x:1100,y:100}], 20, []));
            lineSegments.push(new lineSegment([{x:1000,y:300},{x:1100,y:300}], 21, []));
            lineSegments.push(new lineSegment([{x:1000,y:300},{x:1100,y:500}], 21, []));
        }
    </script>
</html>
